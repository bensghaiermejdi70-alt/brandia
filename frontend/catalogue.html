<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catalogue - Brandia</title>
  <meta name="description" content="D√©couvrez tous les produits des marques sur Brandia">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõçÔ∏è</text></svg>">
  <script src="https://cdn.tailwindcss.com" onerror="loadFallbackTailwind()"></script>
  <script>
    function loadFallbackTailwind() {
      console.warn('[Tailwind] CDN failed, loading fallback...');
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'assets/css/tailwind.css';
      document.head.appendChild(link);
    }
    tailwind = window.tailwind || {};
    tailwind.config = tailwind.config || { darkMode: 'class' };
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" onerror="this.href='https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css'">
  <script src="assets/js/api.js"></script>
  <script src="assets/js/public-products.js"></script>
  <style>
    body { background-color: #111827; color: #f3f4f6; font-family: system-ui, sans-serif; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .product-card:hover { transform: translateY(-4px); box-shadow: 0 10px 40px -10px rgba(99, 102, 241, 0.3); }
    .range-slider { -webkit-appearance: none; width: 100%; height: 6px; background: #374151; outline: none; border-radius: 3px; }
    .range-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: #6366f1; cursor: pointer; border-radius: 50%; }
    .checkbox-custom { appearance: none; width: 16px; height: 16px; border: 2px solid #4b5563; border-radius: 4px; background: #1f2937; cursor: pointer; position: relative; }
    .checkbox-custom:checked { background: #6366f1; border-color: #6366f1; }
    .checkbox-custom:checked::after { content: '‚úì'; position: absolute; color: white; font-size: 10px; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    .skeleton { background: linear-gradient(90deg, #1f2937 25%, #374151 50%, #1f2937 75%); background-size: 200% 100%; animation: skeleton 1.5s infinite; }
    @keyframes skeleton { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .fade-in { animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .dropdown-container { position: relative; }
    .dropdown-menu { display: none; position: absolute; top: 100%; left: 0; margin-top: 0; padding-top: 10px; z-index: 50; }
    .dropdown-container:hover .dropdown-menu, .dropdown-menu:hover { display: block; }
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; border-radius: 8px; color: white; font-weight: 500; z-index: 1000; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: #10b981; }
    .toast.error { background: #ef4444; }
    .promo-badge { animation: pulse-red 2s infinite; }
    @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } }
    .category-radio:checked + span { color: white; font-weight: 500; }
    .category-radio:checked { background: #6366f1; border-color: #6366f1; }
  </style>
  <!-- Responsive utility fallback (si Tailwind absent) -->
  <style>
    @media (min-width: 768px) {
      .md\:flex { display: flex !important; }
      .md\:hidden { display: none !important; }
      .md\:block { display: block !important; }
      .md\:items-center { align-items: center !important; }
    }
    @media (min-width: 1024px) {
      .lg\:flex { display: flex !important; }
      .lg\:grid { display: grid !important; }
    }
  </style>
</head>
<body class="bg-slate-900 text-white antialiased">

<header class="sticky top-0 z-50 bg-neutral-900/95 backdrop-blur border-b border-neutral-800">
  <nav class="container max-w-7xl mx-auto flex items-center justify-between px-4 py-3">
    <a href="index.html" class="flex items-center space-x-3">
      <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded flex items-center justify-center">
        <i class="fas fa-store text-white text-sm"></i>
      </div>
      <span class="font-bold text-lg text-neutral-100">Brandia</span>
    </a>
    
    <div class="hidden md:flex items-center space-x-6 text-sm text-neutral-300">
      <a href="index.html" class="hover:text-white transition">Accueil</a>
      <a href="catalogue.html" class="text-white font-medium">Catalogue</a>
      
      <div class="dropdown-container">
        <div class="dropdown-trigger hover:text-white flex items-center space-x-1 transition cursor-pointer py-2">
          <span>Cat√©gories</span>
          <i class="fas fa-chevron-down text-xs"></i>
        </div>
        <div class="dropdown-menu w-80 bg-neutral-800 rounded-lg shadow-2xl border border-neutral-700 py-2 max-h-[70vh] overflow-y-auto">
          <div id="dropdown-categories-list">
            <div class="text-neutral-500 text-xs px-4 py-2">Chargement...</div>
          </div>
        </div>
      </div>
      
      <a href="marques.html" class="hover:text-white transition">Marques</a>
    </div>

    <div class="flex items-center space-x-3">
      <select id="countrySelector" class="px-2 py-1 bg-neutral-800 rounded text-xs text-neutral-300 border border-neutral-700 focus:border-indigo-500 outline-none min-w-[140px]">
        <option value="">Chargement...</option>
      </select>

      <select id="langSwitch" class="hidden px-2 py-1 bg-neutral-800 rounded text-xs text-neutral-300 border border-neutral-700 focus:border-indigo-500 outline-none">
        <option value="fr">üá´üá∑ FR</option>
        <option value="en">üá¨üáß EN</option>
      </select>

      <div id="auth-buttons" class="flex items-center space-x-2">
        <a href="login.html" class="text-sm text-neutral-300 hover:text-white px-3 py-1.5 rounded-lg hover:bg-neutral-800 transition">Connexion</a>
        <a href="register.html" class="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-sm rounded-lg transition">S'inscrire</a>
      </div>
      
      <div id="user-menu" class="hidden items-center space-x-3">
        <span id="user-name" class="text-sm text-neutral-300"></span>
        <button onclick="BrandiaAPI.Auth.logout()" class="text-sm text-red-400 hover:text-red-300">D√©connexion</button>
      </div>

      <a href="panier.html" class="relative">
        <i class="fas fa-shopping-bag text-neutral-300"></i>
        <span id="cart-count" class="absolute -top-1 -right-1 bg-indigo-500 text-xs rounded-full w-4 h-4 flex items-center justify-center text-white hidden">0</span>
      </a>
    </div>
  </nav>
</header>

<section class="border-b border-neutral-800 bg-neutral-900/50">
  <div class="container max-w-7xl mx-auto px-4 py-4">
    <div class="flex items-center text-sm text-neutral-400 mb-2">
      <a href="index.html" class="hover:text-white transition">Accueil</a>
      <i class="fas fa-chevron-right text-xs mx-2"></i>
      <span class="text-white font-medium" id="page-title">Catalogue</span>
    </div>
    <p class="text-neutral-400 text-sm mt-1" id="results-count">Chargement des produits...</p>
  </div>
</section>

<div class="container max-w-7xl mx-auto px-4 py-6">
  <div class="flex flex-col lg:flex-row gap-6">
    
    <aside class="lg:w-64 flex-shrink-0">
      <div class="lg:sticky lg:top-20 space-y-4">
        
        <div class="lg:hidden mb-4">
          <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500"></i>
            <input type="text" id="mobile-search" placeholder="Rechercher..." class="w-full bg-neutral-800 border border-neutral-700 rounded-lg pl-10 pr-4 py-2 text-sm focus:border-indigo-500 outline-none">
          </div>
        </div>

        <!-- Filtre Promotions -->
        <div class="bg-neutral-800 rounded-lg p-4 border border-neutral-700">
          <h3 class="font-semibold text-white mb-3 flex items-center gap-2">
            <i class="fas fa-fire text-red-500"></i>
            Promotions
          </h3>
          <label class="flex items-center gap-3 cursor-pointer group">
            <input type="checkbox" id="promo-only" class="checkbox-custom" onchange="CatalogueApp.togglePromoOnly()">
            <span class="text-sm text-neutral-300 group-hover:text-white transition">Uniquement en promo</span>
          </label>
        </div>

        <div class="bg-neutral-800 rounded-lg p-4 border border-neutral-700">
          <h3 class="font-semibold text-white mb-3 flex items-center justify-between">
            <span>Prix</span>
            <button onclick="resetPrice()" class="text-xs text-indigo-400 hover:text-indigo-300">R√©initialiser</button>
          </h3>
          <div class="space-y-3">
            <div class="flex gap-2">
              <input type="number" id="price-min" placeholder="Min ‚Ç¨" class="w-full bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-sm focus:border-indigo-500 outline-none">
              <input type="number" id="price-max" placeholder="Max ‚Ç¨" class="w-full bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-sm focus:border-indigo-500 outline-none">
            </div>
            <button onclick="applyPrice()" class="w-full py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded text-sm text-white transition">Appliquer</button>
          </div>
        </div>

        <div class="bg-neutral-800 rounded-lg p-4 border border-neutral-700">
          <h3 class="font-semibold text-white mb-3 flex justify-between items-center">
            <span>Cat√©gories</span>
            <span class="text-xs text-neutral-500" id="cat-count">21</span>
          </h3>
          <div class="space-y-2 max-h-64 overflow-y-auto" id="filter-categories">
            <!-- Les 21 cat√©gories seront inject√©es ici -->
          </div>
        </div>

        <button onclick="resetAll()" class="w-full py-2 border border-neutral-600 text-neutral-300 rounded-lg hover:bg-neutral-800 transition text-sm">
          <i class="fas fa-undo mr-2"></i>R√©initialiser filtres
        </button>
      </div>
    </aside>

    <main class="flex-1">
      
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 bg-neutral-800/50 p-3 rounded-lg border border-neutral-700">
        
        <div class="hidden lg:block relative flex-1 max-w-md">
          <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500"></i>
          <input type="text" id="search-input" placeholder="Rechercher un produit..." class="w-full bg-neutral-900 border border-neutral-700 rounded-lg pl-10 pr-4 py-2 text-sm focus:border-indigo-500 outline-none">
        </div>

        <div class="flex items-center gap-3 w-full sm:w-auto">
          <select id="sort-select" onchange="CatalogueApp.sortProducts()" class="bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 outline-none flex-1 sm:flex-none">
            <option value="newest">Plus r√©cents</option>
            <option value="price_asc">Prix croissant</option>
            <option value="price_desc">Prix d√©croissant</option>
            <option value="promo">Meilleures promos</option>
          </select>
        </div>
      </div>

      <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        <div class="col-span-full text-center py-12">
          <i class="fas fa-spinner fa-spin text-indigo-400 text-2xl mb-2"></i>
          <p class="text-neutral-500">Chargement des produits...</p>
        </div>
      </div>

      <div id="empty-state" class="hidden text-center py-16">
        <i class="fas fa-search text-6xl text-neutral-600 mb-4"></i>
        <h3 class="text-xl font-semibold text-white mb-2">Aucun produit trouv√©</h3>
        <p class="text-neutral-400 mb-4">Essayez de modifier vos filtres ou votre recherche</p>
        <button onclick="resetAll()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg transition">R√©initialiser</button>
      </div>
    </main>
  </div>
</div>

<footer class="border-t border-neutral-800 py-6 text-center text-xs text-neutral-500 mt-12">
  ¬© 2026 Brandia ‚Äì Marketplace officielle des marques
</footer>

<div id="toast" class="toast"></div>

<script>
// ==========================================
// LES 21 CAT√âGORIES
// ==========================================
const BRANDIA_CATEGORIES = [
  { slug: 'cosmetiques-soins-peau', name: 'Cosm√©tiques & soins de la peau', icon: 'fa-spa', gradient: 'from-pink-500 to-rose-600' },
  { slug: 'parfums-fragrances', name: 'Parfums & fragrances', icon: 'fa-spray-can', gradient: 'from-purple-500 to-indigo-600' },
  { slug: 'maquillage', name: 'Maquillage', icon: 'fa-magic', gradient: 'from-red-500 to-pink-600' },
  { slug: 'soins-capillaires', name: 'Soins capillaires', icon: 'fa-cut', gradient: 'from-amber-500 to-orange-600' },
  { slug: 'complements-bien-etre', name: 'Compl√©ments bien-√™tre', icon: 'fa-heart', gradient: 'from-emerald-500 to-teal-600' },
  { slug: 'mode-accessoires', name: 'Mode & accessoires', icon: 'fa-tshirt', gradient: 'from-blue-500 to-cyan-600' },
  { slug: 'montres-bijoux', name: 'Montres & bijoux', icon: 'fa-gem', gradient: 'from-yellow-500 to-amber-600' },
  { slug: 'sport-fitness', name: 'Articles de sport', icon: 'fa-dumbbell', gradient: 'from-orange-500 to-red-600' },
  { slug: 'nutrition-sportive', name: 'Nutrition sportive', icon: 'fa-apple-alt', gradient: 'from-green-500 to-emerald-600' },
  { slug: 'high-tech-mobile', name: 'High-tech & mobile', icon: 'fa-mobile-alt', gradient: 'from-indigo-500 to-blue-600' },
  { slug: 'electronique-lifestyle', name: '√âlectronique', icon: 'fa-headphones', gradient: 'from-violet-500 to-purple-600' },
  { slug: 'maison-decoration', name: 'Maison & d√©coration', icon: 'fa-home', gradient: 'from-orange-500 to-red-500' },
  { slug: 'parfumerie-interieur', name: 'Parfumerie int√©rieur', icon: 'fa-fire', gradient: 'from-rose-400 to-pink-500' },
  { slug: 'produits-ecologiques', name: 'Produits √©cologiques', icon: 'fa-leaf', gradient: 'from-green-400 to-emerald-500' },
  { slug: 'bebe-maternite', name: 'B√©b√© & maternit√©', icon: 'fa-baby', gradient: 'from-sky-400 to-blue-500' },
  { slug: 'animaux-pets', name: 'Animaux', icon: 'fa-paw', gradient: 'from-amber-600 to-yellow-600' },
  { slug: 'sante-hygiene', name: 'Sant√© & hygi√®ne', icon: 'fa-heartbeat', gradient: 'from-red-400 to-rose-500' },
  { slug: 'bagagerie-voyage', name: 'Bagagerie & voyage', icon: 'fa-suitcase', gradient: 'from-violet-500 to-purple-600' },
  { slug: 'papeterie-lifestyle', name: 'Papeterie premium', icon: 'fa-pen-fancy', gradient: 'from-teal-400 to-cyan-500' },
  { slug: 'artisanat-local', name: 'Artisanat local', icon: 'fa-hands', gradient: 'from-orange-400 to-amber-500' },
  { slug: 'sport-loisirs', name: 'Sport & loisirs', icon: 'fa-bicycle', gradient: 'from-cyan-500 to-blue-600' }
];

// ==========================================
// CONFIGURATION PAYS (28 pays)
// ==========================================
const COUNTRIES = {
  'AF': { name: 'Afghanistan', currency: 'AFN' },
      'AL': { name: 'Albanie', currency: 'ALL' },
      'DZ': { name: 'Alg√©rie', currency: 'DZD' },
      'AD': { name: 'Andorre', currency: 'EUR' },
      'AO': { name: 'Angola', currency: 'AOA' },
      'AG': { name: 'Antigua-et-Barbuda', currency: 'XCD' },
      'AR': { name: 'Argentine', currency: 'ARS' },
      'AM': { name: 'Arm√©nie', currency: 'AMD' },
      'AU': { name: 'Australie', currency: 'AUD' },
      'AT': { name: 'Autriche', currency: 'EUR' },
      'AZ': { name: 'Azerba√Ødjan', currency: 'AZN' },
      'BS': { name: 'Bahamas', currency: 'BSD' },
      'BH': { name: 'Bahre√Øn', currency: 'BHD' },
      'BD': { name: 'Bangladesh', currency: 'BDT' },
      'BB': { name: 'Barbade', currency: 'BBD' },
      'BY': { name: 'Bi√©lorussie', currency: 'BYN' },
      'BE': { name: 'Belgique', currency: 'EUR' },
      'BZ': { name: 'Belize', currency: 'BZD' },
      'BJ': { name: 'B√©nin', currency: 'XOF' },
      'BT': { name: 'Bhoutan', currency: 'BTN' },
      'BO': { name: 'Bolivie', currency: 'BOB' },
      'BA': { name: 'Bosnie-Herz√©govine', currency: 'BAM' },
      'BW': { name: 'Botswana', currency: 'BWP' },
      'BR': { name: 'Br√©sil', currency: 'BRL' },
      'BN': { name: 'Brunei', currency: 'BND' },
      'BG': { name: 'Bulgarie', currency: 'BGN' },
      'BF': { name: 'Burkina Faso', currency: 'XOF' },
      'BI': { name: 'Burundi', currency: 'BIF' },
      'CV': { name: 'Cap-Vert', currency: 'CVE' },
      'KH': { name: 'Cambodge', currency: 'KHR' },
      'CM': { name: 'Cameroun', currency: 'XAF' },
      'CA': { name: 'Canada', currency: 'CAD' },
      'CF': { name: 'Centrafrique', currency: 'XAF' },
      'TD': { name: 'Tchad', currency: 'XAF' },
      'CL': { name: 'Chili', currency: 'CLP' },
      'CN': { name: 'Chine', currency: 'CNY' },
      'CO': { name: 'Colombie', currency: 'COP' },
      'KM': { name: 'Comores', currency: 'KMF' },
      'CG': { name: 'Congo', currency: 'XAF' },
      'CD': { name: 'Congo (RDC)', currency: 'CDF' },
      'CR': { name: 'Costa Rica', currency: 'CRC' },
      'CI': { name: 'C√¥te d‚ÄôIvoire', currency: 'XOF' },
      'HR': { name: 'Croatie', currency: 'EUR' },
      'CU': { name: 'Cuba', currency: 'CUP' },
      'CY': { name: 'Chypre', currency: 'EUR' },
      'CZ': { name: 'R√©publique tch√®que', currency: 'CZK' },
      'DK': { name: 'Danemark', currency: 'DKK' },
      'DJ': { name: 'Djibouti', currency: 'DJF' },
      'DM': { name: 'Dominique', currency: 'XCD' },
      'DO': { name: 'R√©publique dominicaine', currency: 'DOP' },
      'EC': { name: '√âquateur', currency: 'USD' },
      'EG': { name: '√âgypte', currency: 'EGP' },
      'SV': { name: 'Salvador', currency: 'USD' },
      'GQ': { name: 'Guin√©e √©quatoriale', currency: 'XAF' },
      'ER': { name: '√ârythr√©e', currency: 'ERN' },
      'EE': { name: 'Estonie', currency: 'EUR' },
      'ET': { name: '√âthiopie', currency: 'ETB' },
      'FJ': { name: 'Fidji', currency: 'FJD' },
      'FI': { name: 'Finlande', currency: 'EUR' },
      'FR': { name: 'France', currency: 'EUR' },
      'GA': { name: 'Gabon', currency: 'XAF' },
      'GM': { name: 'Gambie', currency: 'GMD' },
      'GE': { name: 'G√©orgie', currency: 'GEL' },
      'DE': { name: 'Allemagne', currency: 'EUR' },
      'GH': { name: 'Ghana', currency: 'GHS' },
      'GR': { name: 'Gr√®ce', currency: 'EUR' },
      'GD': { name: 'Grenade', currency: 'XCD' },
      'GT': { name: 'Guatemala', currency: 'GTQ' },
      'GN': { name: 'Guin√©e', currency: 'GNF' },
      'GW': { name: 'Guin√©e-Bissau', currency: 'XOF' },
      'GY': { name: 'Guyana', currency: 'GYD' },
      'HT': { name: 'Ha√Øti', currency: 'HTG' },
      'HN': { name: 'Honduras', currency: 'HNL' },
      'HU': { name: 'Hongrie', currency: 'HUF' },
      'IS': { name: 'Islande', currency: 'ISK' },
      'IN': { name: 'Inde', currency: 'INR' },
      'ID': { name: 'Indon√©sie', currency: 'IDR' },
      'IR': { name: 'Iran', currency: 'IRR' },
      'IQ': { name: 'Irak', currency: 'IQD' },
      'IE': { name: 'Irlande', currency: 'EUR' },
      'IL': { name: 'Isra√´l', currency: 'ILS' },
      'IT': { name: 'Italie', currency: 'EUR' },
      'JM': { name: 'Jama√Øque', currency: 'JMD' },
      'JP': { name: 'Japon', currency: 'JPY' },
      'JO': { name: 'Jordanie', currency: 'JOD' },
      'KZ': { name: 'Kazakhstan', currency: 'KZT' },
      'KE': { name: 'Kenya', currency: 'KES' },
      'KI': { name: 'Kiribati', currency: 'AUD' },
      'KP': { name: 'Cor√©e du Nord', currency: 'KPW' },
      'KR': { name: 'Cor√©e du Sud', currency: 'KRW' },
      'KW': { name: 'Kowe√Øt', currency: 'KWD' },
      'KG': { name: 'Kirghizistan', currency: 'KGS' },
      'LA': { name: 'Laos', currency: 'LAK' },
      'LV': { name: 'Lettonie', currency: 'EUR' },
      'LB': { name: 'Liban', currency: 'LBP' },
      'LS': { name: 'Lesotho', currency: 'LSL' },
      'LR': { name: 'Lib√©ria', currency: 'LRD' },
      'LY': { name: 'Libye', currency: 'LYD' },
      'LI': { name: 'Liechtenstein', currency: 'CHF' },
      'LT': { name: 'Lituanie', currency: 'EUR' },
      'LU': { name: 'Luxembourg', currency: 'EUR' },
      'MG': { name: 'Madagascar', currency: 'MGA' },
      'MW': { name: 'Malawi', currency: 'MWK' },
      'MY': { name: 'Malaisie', currency: 'MYR' },
      'MV': { name: 'Maldives', currency: 'MVR' },
      'ML': { name: 'Mali', currency: 'XOF' },
      'MT': { name: 'Malte', currency: 'EUR' },
      'MH': { name: '√éles Marshall', currency: 'USD' },
      'MR': { name: 'Mauritanie', currency: 'MRO' },
      'MU': { name: 'Maurice', currency: 'MUR' },
      'MX': { name: 'Mexique', currency: 'MXN' },
      'FM': { name: '√âtats f√©d√©r√©s de Micron√©sie', currency: 'USD' },
      'MD': { name: 'Moldavie', currency: 'MDL' },
      'MC': { name: 'Monaco', currency: 'EUR' },
      'MN': { name: 'Mongolie', currency: 'MNT' },
      'ME': { name: 'Mont√©n√©gro', currency: 'EUR' },
      'MA': { name: 'Maroc', currency: 'MAD' },
      'MZ': { name: 'Mozambique', currency: 'MZN' },
      'MM': { name: 'Myanmar', currency: 'MMK' },
      'NA': { name: 'Namibie', currency: 'NAD' },
      'NR': { name: 'Nauru', currency: 'AUD' },
      'NP': { name: 'N√©pal', currency: 'NPR' },
      'NL': { name: 'Pays-Bas', currency: 'EUR' },
      'NZ': { name: 'Nouvelle-Z√©lande', currency: 'NZD' },
      'NI': { name: 'Nicaragua', currency: 'NIO' },
      'NE': { name: 'Niger', currency: 'XOF' },
      'NG': { name: 'Nig√©ria', currency: 'NGN' },
      'NO': { name: 'Norv√®ge', currency: 'NOK' },
      'OM': { name: 'Oman', currency: 'OMR' },
      'PK': { name: 'Pakistan', currency: 'PKR' },
      'PW': { name: 'Palaos', currency: 'USD' },
      'PA': { name: 'Panama', currency: 'PAB' },
      'PG': { name: 'Papouasie-Nouvelle-Guin√©e', currency: 'PGK' },
      'PY': { name: 'Paraguay', currency: 'PYG' },
      'PE': { name: 'P√©rou', currency: 'PEN' },
      'PH': { name: 'Philippines', currency: 'PHP' },
      'PL': { name: 'Pologne', currency: 'PLN' },
      'PT': { name: 'Portugal', currency: 'EUR' },
      'QA': { name: 'Qatar', currency: 'QAR' },
      'RO': { name: 'Roumanie', currency: 'RON' },
      'RU': { name: 'Russie', currency: 'RUB' },
      'RW': { name: 'Rwanda', currency: 'RWF' },
      'KN': { name: 'Saint-Kitts-et-Nevis', currency: 'XCD' },
      'LC': { name: 'Sainte-Lucie', currency: 'XCD' },
      'VC': { name: 'Saint-Vincent-et-les-Grenadines', currency: 'XCD' },
      'WS': { name: 'Samoa', currency: 'WST' },
      'SM': { name: 'Saint-Marin', currency: 'EUR' },
      'ST': { name: 'Sao Tom√©-et-Principe', currency: 'STN' },
      'SA': { name: 'Arabie saoudite', currency: 'SAR' },
      'SN': { name: 'S√©n√©gal', currency: 'XOF' },
      'RS': { name: 'Serbie', currency: 'RSD' },
      'SC': { name: 'Seychelles', currency: 'SCR' },
      'SL': { name: 'Sierra Leone', currency: 'SLL' },
      'SG': { name: 'Singapour', currency: 'SGD' },
      'SK': { name: 'Slovaquie', currency: 'EUR' },
      'SI': { name: 'Slov√©nie', currency: 'EUR' },
      'SB': { name: '√éles Salomon', currency: 'SBD' },
      'SO': { name: 'Somalie', currency: 'SOS' },
      'ZA': { name: 'Afrique du Sud', currency: 'ZAR' },
      'ES': { name: 'Espagne', currency: 'EUR' },
      'LK': { name: 'Sri Lanka', currency: 'LKR' },
      'SD': { name: 'Soudan', currency: 'SDG' },
      'SR': { name: 'Suriname', currency: 'SRD' },
      'SE': { name: 'Su√®de', currency: 'SEK' },
      'CH': { name: 'Suisse', currency: 'CHF' },
      'SY': { name: 'Syrie', currency: 'SYP' },
      'TW': { name: 'Ta√Øwan', currency: 'TWD' },
      'TJ': { name: 'Tadjikistan', currency: 'TJS' },
      'TZ': { name: 'Tanzanie', currency: 'TZS' },
      'TH': { name: 'Tha√Ølande', currency: 'THB' },
      'TL': { name: 'Timor oriental', currency: 'USD' },
      'TG': { name: 'Togo', currency: 'XOF' },
      'TO': { name: 'Tonga', currency: 'TOP' },
      'TT': { name: 'Trinit√©-et-Tobago', currency: 'TTD' },
      'TN': { name: 'Tunisie', currency: 'TND' },
      'TR': { name: 'Turquie', currency: 'TRY' },
      'TM': { name: 'Turkm√©nistan', currency: 'TMT' },
      'UG': { name: 'Ouganda', currency: 'UGX' },
      'UA': { name: 'Ukraine', currency: 'UAH' },
      'AE': { name: '√âmirats arabes unis', currency: 'AED' },
      'GB': { name: 'Royaume-Uni', currency: 'GBP' },
      'US': { name: '√âtats-Unis', currency: 'USD' },
      'UY': { name: 'Uruguay', currency: 'UYU' },
      'UZ': { name: 'Ouzb√©kistan', currency: 'UZS' },
      'VU': { name: 'Vanuatu', currency: 'VUV' },
      'VE': { name: 'Venezuela', currency: 'VES' },
      'VN': { name: 'Vi√™t Nam', currency: 'VND' },
      'YE': { name: 'Y√©men', currency: 'YER' },
      'ZM': { name: 'Zambie', currency: 'ZMW' },
      'ZW': { name: 'Zimbabwe', currency: 'ZWL' }
};

// ==========================================
// CATALOGUE APP
// ==========================================
window.CatalogueApp = {
  state: {
    allProducts: [],
    filteredProducts: [],
    filters: {
      category: null,
      search: '',
      minPrice: null,
      maxPrice: null,
      promoOnly: false
    },
    sortBy: 'newest'
  },

  init: async () => {
    console.log('[CatalogueApp] Initialisation...');
    initCountrySelector();
    initFilters();
    initSearch();
    initAuth();
    await CatalogueApp.loadProducts();
    updateCartBadge();
  },

  loadProducts: async () => {
    const container = document.getElementById('products-container');
    container.innerHTML = '<div class="col-span-full text-center py-12"><i class="fas fa-spinner fa-spin text-indigo-400 text-2xl mb-2"></i><p class="text-neutral-500">Chargement des produits...</p></div>';

    let category = CatalogueApp.state.filters.category;
    
    if (!category || category === 'null' || category === 'undefined' || category === '') {
      category = null;
    }
    
    console.log('[CatalogueApp] Loading with category:', category);

    try {
      const params = {};
      if (category) {
        params.category = category;
      }
      params.limit = 100;

      const response = await BrandiaAPI.Products.getAllWithPromotions(params);

      console.log('[CatalogueApp] R√©ponse API:', response);

      if (response.success) {
        const products = response.data?.products || 
                        (Array.isArray(response.data) ? response.data : []) ||
                        [];
        
        console.log('[CatalogueApp] Produits extraits:', products.length);
        
        CatalogueApp.state.allProducts = products;
        CatalogueApp.applyFilters();
        
        if (response.data?.promo_count > 0 || products.some(p => p.has_promotion)) {
          const promoCount = products.filter(p => p.has_promotion).length;
          console.log(`[CatalogueApp] ${promoCount} produits en promotion`);
        }
      } else {
        throw new Error(response.message);
      }

    } catch (error) {
      console.error('[CatalogueApp] Erreur API avec promotions:', error);
      try {
        const fallback = await BrandiaAPI.Products.getAll({ limit: 100 });
        if (fallback.success) {
          const products = fallback.data?.products || 
                          (Array.isArray(fallback.data) ? fallback.data : []) ||
                          [];
          CatalogueApp.state.allProducts = products;
          CatalogueApp.applyFilters();
        }
      } catch (fallbackError) {
        console.error('[CatalogueApp] Fallback failed:', fallbackError);
        container.innerHTML = `
          <div class="col-span-full text-center text-red-400 py-12">
            <i class="fas fa-exclamation-circle text-3xl mb-4"></i>
            <p>Erreur de connexion au serveur</p>
            <button onclick="CatalogueApp.loadProducts()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-500">
              R√©essayer
            </button>
          </div>
        `;
      }
    }
  },

  applyFilters: () => {
    let products = [...CatalogueApp.state.allProducts];
    const f = CatalogueApp.state.filters;

    if (f.search) {
      const search = f.search.toLowerCase();
      products = products.filter(p => 
        p.name?.toLowerCase().includes(search) ||
        p.description?.toLowerCase().includes(search) ||
        p.supplier_company?.toLowerCase().includes(search)
      );
    }

    if (f.minPrice) {
      products = products.filter(p => parseFloat(p.final_price || p.price) >= f.minPrice);
    }
    if (f.maxPrice) {
      products = products.filter(p => parseFloat(p.final_price || p.price) <= f.maxPrice);
    }

    if (f.promoOnly) {
      products = products.filter(p => p.has_promotion === true);
    }

    products = CatalogueApp.sortProductsList(products);

    CatalogueApp.state.filteredProducts = products;
    CatalogueApp.renderProducts(products);
  },

  sortProductsList: (products) => {
    const sort = CatalogueApp.state.sortBy;
    
    return products.sort((a, b) => {
      const priceA = parseFloat(a.final_price || a.price);
      const priceB = parseFloat(b.final_price || b.price);
      
      switch(sort) {
        case 'price_asc':
          return priceA - priceB;
        case 'price_desc':
          return priceB - priceA;
        case 'promo':
          if (a.has_promotion && !b.has_promotion) return -1;
          if (!a.has_promotion && b.has_promotion) return 1;
          if (a.has_promotion && b.has_promotion) {
            const savingsA = (a.base_price || a.price) - priceA;
            const savingsB = (b.base_price || b.price) - priceB;
            return savingsB - savingsA;
          }
          return 0;
        case 'newest':
        default:
          return new Date(b.created_at) - new Date(a.created_at);
      }
    });
  },
  renderProducts: (products) => {
    const container = document.getElementById('products-container');
    const resultsCount = document.getElementById('results-count');
    const emptyState = document.getElementById('empty-state');

    const promoCount = products.filter(p => p.has_promotion).length;
    resultsCount.textContent = `${products.length} produit(s) trouv√©(s)${promoCount > 0 ? ` (${promoCount} en promo)` : ''}`;

    if (products.length === 0) {
      container.innerHTML = '';
      emptyState.classList.remove('hidden');
      return;
    }

    emptyState.classList.add('hidden');

    container.innerHTML = products.map((p, index) => {
      if (window.PublicProducts && PublicProducts.renderProductCard) {
        return PublicProducts.renderProductCard(p);
      }
      return CatalogueApp.renderProductCardFallback(p, index);
    }).join('');
  },

  renderProductCardFallback: (p, index) => {
    const hasPromo = p.has_promotion === true;
    const finalPrice = parseFloat(p.final_price || p.price);
    const basePrice = parseFloat(p.base_price || p.original_price || p.price);
    
    let savingsAmount = 0;
    let savingsPercent = 0;
    
    if (hasPromo && basePrice > finalPrice) {
      savingsAmount = basePrice - finalPrice;
      savingsPercent = Math.round((savingsAmount / basePrice) * 100);
    }

    const promoBadge = hasPromo ? `
      <div class="absolute top-2 left-2 z-10 promo-badge">
        <span class="bg-gradient-to-r from-red-500 to-pink-600 text-white text-xs font-bold px-2 py-1 rounded-full shadow-lg">
          <i class="fas fa-fire mr-1"></i>-${p.discount_display || savingsPercent + '%'}
        </span>
      </div>
    ` : '';

    const priceDisplay = hasPromo ? `
      <div class="flex flex-col">
        <span class="text-neutral-500 line-through text-xs">${basePrice.toFixed(2)} ‚Ç¨</span>
        <div class="flex items-center gap-2">
          <span class="text-emerald-400 font-bold text-lg">${finalPrice.toFixed(2)} ‚Ç¨</span>
          <span class="text-xs text-emerald-500 bg-emerald-500/10 px-1.5 py-0.5 rounded">
            -${savingsAmount.toFixed(2)} ‚Ç¨
          </span>
        </div>
      </div>
    ` : `
      <span class="text-lg font-bold text-white">${finalPrice.toFixed(2)} ‚Ç¨</span>
    `;

    const promoInfo = hasPromo ? `
      <div class="mt-2 p-2 bg-gradient-to-r from-indigo-500/10 to-purple-500/10 rounded border border-indigo-500/20">
        <div class="flex items-center gap-2 text-xs text-indigo-300">
          <i class="fas fa-tag"></i>
          <span class="truncate">${p.promo_name || 'Promotion en cours'}</span>
        </div>
        ${p.promo_end_date ? `
          <div class="text-xs text-amber-400 mt-1">
            <i class="fas fa-clock mr-1"></i>
            Jusqu'au ${new Date(p.promo_end_date).toLocaleDateString('fr-FR')}
          </div>
        ` : ''}
      </div>
    ` : '';

    const image = p.main_image_url || 'https://images.unsplash.com/photo-1555529669-e69e7aa0ba9a?w=400&q=80';

    return `
      <div class="product-card group bg-neutral-800 rounded-lg overflow-hidden border border-neutral-700 hover:border-indigo-500 transition-all duration-300 fade-in" style="animation-delay: ${index * 0.05}s">
        <a href="product.html?id=${p.id}" class="block relative">
          <div class="aspect-square overflow-hidden bg-neutral-900">
            <img src="${image}" alt="${p.name}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500" loading="lazy" onerror="this.src='https://images.unsplash.com/photo-1555529669-e69e7aa0ba9a?w=400&q=80'">
          </div>
          ${promoBadge}
          ${p.stock_quantity < 5 ? `<span class="absolute top-2 right-2 bg-amber-500 text-white text-xs font-bold px-2 py-1 rounded">Stock faible</span>` : ''}
        </a>
        <div class="p-4">
          <h3 class="text-sm font-medium text-white mb-1 line-clamp-2 hover:text-indigo-400 transition cursor-pointer" onclick="window.location.href='product.html?id=${p.id}'">${p.name}</h3>
          <p class="text-xs text-neutral-500 mb-2">${p.supplier_company || p.supplier_name || 'Marque'}</p>
          
          ${priceDisplay}
          ${promoInfo}
          
          <div class="mt-3 flex gap-2">
            <button onclick="event.preventDefault(); CatalogueApp.addToCart(${p.id})" 
                    class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-2 rounded text-sm transition flex items-center justify-center gap-2">
              <i class="fas fa-cart-plus"></i>
              Ajouter
            </button>
            <a href="product.html?id=${p.id}" class="px-3 py-2 bg-neutral-700 hover:bg-neutral-600 text-white rounded text-sm transition">
              <i class="fas fa-eye"></i>
            </a>
          </div>
        </div>
      </div>
    `;
  },

  addToCart: async (productId) => {
    try {
      const response = await BrandiaAPI.Products.getByIdWithPromotion(productId);
      
      if (!response.success || !response.data.product) {
        throw new Error('Produit non trouv√©');
      }

      const product = response.data.product;
      
      const cartItem = {
        id: product.id,
        name: product.name,
        price: product.final_price || product.price,
        original_price: product.base_price || product.price,
        has_promotion: product.has_promotion,
        promo_code: product.promo_code,
        main_image_url: product.main_image_url,
        quantity: 1
      };

      if (window.BrandiaAPI && BrandiaAPI.Cart) {
        BrandiaAPI.Cart.add(cartItem);
      } else {
        let cart = JSON.parse(localStorage.getItem('brandia_cart') || '[]');
        const existing = cart.find(x => x.id === product.id);
        if (existing) {
          existing.quantity++;
        } else {
          cart.push(cartItem);
        }
        localStorage.setItem('brandia_cart', JSON.stringify(cart));
      }

      showToast('Produit ajout√© au panier !', 'success');
      updateCartBadge();

    } catch (error) {
      console.error('[CatalogueApp] Erreur ajout panier:', error);
      showToast('Erreur lors de l\'ajout', 'error');
    }
  },
  // ==========================================
  // üî• CORRECTION: Virgule ajout√©e avant togglePromoOnly
  // ==========================================
  
  togglePromoOnly: () => {
    const checkbox = document.getElementById('promo-only');
    const isChecked = checkbox.checked;
    
    console.log('[CatalogueApp] Toggle promo only:', isChecked);
    
    CatalogueApp.state.filters.promoOnly = isChecked;
    
    // Si promo_only activ√©, recharger depuis API avec param√®tre
    if (isChecked) {
      CatalogueApp.loadProductsWithPromoFilter();
    } else {
      // Sinon, recharger tous les produits normalement
      CatalogueApp.loadProducts();
    }
  },

  // üî• Nouvelle m√©thode pour charger avec filtre promo
  loadProductsWithPromoFilter: async () => {
    const container = document.getElementById('products-container');
    container.innerHTML = '<div class="col-span-full text-center py-12"><i class="fas fa-spinner fa-spin text-indigo-400 text-2xl mb-2"></i><p class="text-neutral-500">Chargement des promotions...</p></div>';

    try {
      const params = {
        promo_only: true,
        limit: 100
      };

      // Garder le filtre cat√©gorie si actif
      if (CatalogueApp.state.filters.category) {
        params.category = CatalogueApp.state.filters.category;
      }

      const response = await BrandiaAPI.Products.getAllWithPromotions(params);

      console.log('[CatalogueApp] Promo filter response:', response);

      if (response.success) {
        const products = response.data?.products || [];
        
        console.log(`[CatalogueApp] ${products.length} produits dont ${response.promo_count} en promo`);
        
        CatalogueApp.state.allProducts = products;
        
        // Appliquer les autres filtres (recherche, prix) mais pas promo
        let filtered = [...products];
        
        // Filtre recherche
        if (CatalogueApp.state.filters.search) {
          const search = CatalogueApp.state.filters.search.toLowerCase();
          filtered = filtered.filter(p => 
            p.name?.toLowerCase().includes(search) ||
            p.description?.toLowerCase().includes(search)
          );
        }
        
        // Filtre prix
        if (CatalogueApp.state.filters.minPrice) {
          filtered = filtered.filter(p => p.final_price >= CatalogueApp.state.filters.minPrice);
        }
        if (CatalogueApp.state.filters.maxPrice) {
          filtered = filtered.filter(p => p.final_price <= CatalogueApp.state.filters.maxPrice);
        }
        
        // Tri
        filtered = CatalogueApp.sortProductsList(filtered);
        
        CatalogueApp.renderProducts(filtered);
        
        // Mettre √† jour le compteur
        const resultsCount = document.getElementById('results-count');
        const promoCount = filtered.filter(p => p.has_promotion).length;
        resultsCount.textContent = `${filtered.length} produit(s) trouv√©(s) dont ${promoCount} en promotion`;
      } else {
        throw new Error(response.message);
      }

    } catch (error) {
      console.error('[CatalogueApp] Erreur chargement promos:', error);
      container.innerHTML = `
        <div class="col-span-full text-center text-red-400 py-12">
          <i class="fas fa-exclamation-circle text-3xl mb-4"></i>
          <p>Erreur lors du chargement des promotions</p>
          <button onclick="CatalogueApp.togglePromoOnly()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-500">
            R√©essayer
          </button>
        </div>
      `;
    }
  },

  sortProducts: () => {
    const select = document.getElementById('sort-select');
    CatalogueApp.state.sortBy = select.value;
    CatalogueApp.applyFilters();
  }
};
// ==========================================
// FONCTIONS UTILITAIRES
// ==========================================
function getFlagEmoji(countryCode) {
  const flags = { 
    "AF": "üá¶üá´", "AX": "üá¶üáΩ", "AL": "üá¶üá±", "DZ": "üá©üáø", "AS": "üá¶üá∏",
  "AD": "üá¶üá©", "AO": "üá¶üá¥", "AI": "üá¶üáÆ", "AQ": "üá¶üá∂", "AG": "üá¶üá¨",
  "AR": "üá¶üá∑", "AM": "üá¶üá≤", "AW": "üá¶üáº", "AU": "üá¶üá∫", "AT": "üá¶üáπ",
  "AZ": "üá¶üáø", "BS": "üáßüá∏", "BH": "üáßüá≠", "BD": "üáßüá©", "BB": "üáßüáß",
  "BY": "üáßüáæ", "BE": "üáßüá™", "BZ": "üáßüáø", "BJ": "üáßüáØ", "BM": "üáßüá≤",
  "BT": "üáßüáπ", "BO": "üáßüá¥", "BQ": "üáßüá∂", "BA": "üáßüá¶", "BW": "üáßüáº",
  "BV": "üáßüáª", "BR": "üáßüá∑", "IO": "üáÆüá¥", "VG": "üáªüá¨", "BN": "üáßüá≥",
  "BG": "üáßüá¨", "BF": "üáßüá´", "BI": "üáßüáÆ", "CV": "üá®üáª", "KH": "üá∞üá≠",
  "CM": "üá®üá≤", "CA": "üá®üá¶", "KY": "üá∞üáæ", "CF": "üá®üá´", "TD": "üáπüá©",
  "CL": "üá®üá±", "CN": "üá®üá≥", "CX": "üá®üáΩ", "CC": "üá®üá®", "CO": "üá®üá¥",
  "KM": "üá∞üá≤", "CG": "üá®üá¨", "CD": "üá®üá©", "CK": "üá®üá∞", "CR": "üá®üá∑",
  "CI": "üá®üáÆ", "HR": "üá≠üá∑", "CU": "üá®üá∫", "CW": "üá®üáº", "CY": "üá®üáæ",
  "CZ": "üá®üáø", "DK": "üá©üá∞", "DJ": "üá©üáØ", "DM": "üá©üá≤", "DO": "üá©üá¥",
  "EC": "üá™üá®", "EG": "üá™üá¨", "SV": "üá∏üáª", "GQ": "üá¨üá∂", "ER": "üá™üá∑",
  "EE": "üá™üá™", "ET": "üá™üáπ", "FK": "üá´üá∞", "FO": "üá´üá¥", "FJ": "üá´üáØ",
  "FI": "üá´üáÆ", "FR": "üá´üá∑", "GF": "üá¨üá´", "PF": "üáµüá´", "TF": "üáπüá´",
  "GA": "üá¨üá¶", "GM": "üá¨üá≤", "GE": "üá¨üá™", "DE": "üá©üá™", "GH": "üá¨üá≠",
  "GI": "üá¨üáÆ", "GR": "üá¨üá∑", "GL": "üá¨üá±", "GD": "üá¨üá©", "GP": "üá¨üáµ",
  "GU": "üá¨üá∫", "GT": "üá¨üáπ", "GG": "üá¨üá¨", "GN": "üá¨üá≥", "GW": "üá¨üáº",
  "GY": "üá¨üáæ", "HT": "üá≠üáπ", "HM": "üá≠üá≤", "VA": "üáªüá¶", "HN": "üá≠üá≥",
  "HK": "üá≠üá∞", "HU": "üá≠üá∫", "IS": "üáÆüá∏", "IN": "üáÆüá≥", "ID": "üáÆüá©",
  "IR": "üáÆüá∑", "IQ": "üáÆüá∂", "IE": "üáÆüá™", "IM": "üáÆüá≤", "IL": "üáÆüá±",
  "IT": "üáÆüáπ", "JM": "üáØüá≤", "JP": "üáØüáµ", "JE": "üáØüá™", "JO": "üáØüá¥",
  "KZ": "üá∞üáø", "KE": "üá∞üá™", "KI": "üá∞üáÆ", "KP": "üá∞üáµ", "KR": "üá∞üá∑",
  "KW": "üá∞üáº", "KG": "üá∞üá¨", "LA": "üá±üá¶", "LV": "üá±üáª", "LB": "üá±üáß",
  "LS": "üá±üá∏", "LR": "üá±üá∑", "LY": "üá±üáæ", "LI": "üá±üáÆ", "LT": "üá±üáπ",
  "LU": "üá±üá∫", "MO": "üá≤üá¥", "MK": "üá≤üá∞", "MG": "üá≤üá¨", "MW": "üá≤üáº",
  "MY": "üá≤üáæ", "MV": "üá≤üáª", "ML": "üá≤üá±", "MT": "üá≤üáπ", "MH": "üá≤üá≠",
  "MQ": "üá≤üá∂", "MR": "üá≤üá∑", "MU": "üá≤üá∫", "YT": "üáæüáπ", "MX": "üá≤üáΩ",
  "FM": "üá´üá≤", "MD": "üá≤üá©", "MC": "üá≤üá®", "MN": "üá≤üá≥", "ME": "üá≤üá™",
  "MS": "üá≤üá∏", "MA": "üá≤üá¶", "MZ": "üá≤üáø", "MM": "üá≤üá≤", "NA": "üá≥üá¶",
  "NR": "üá≥üá∑", "NP": "üá≥üáµ", "NL": "üá≥üá±", "NC": "üá≥üá®", "NZ": "üá≥üáø",
  "NI": "üá≥üáÆ", "NE": "üá≥üá™", "NG": "üá≥üá¨", "NU": "üá≥üá∫", "NF": "üá≥üá´",
  "MP": "üá≤üáµ", "NO": "üá≥üá¥", "OM": "üá¥üá≤", "PK": "üáµüá∞", "PW": "üáµüáº",
  "PS": "üáµüá∏", "PA": "üáµüá¶", "PG": "üáµüá¨", "PY": "üáµüáæ", "PE": "üáµüá™",
  "PH": "üáµüá≠", "PN": "üáµüá≥", "PL": "üáµüá±", "PT": "üáµüáπ", "PR": "üáµüá∑",
  "QA": "üá∂üá¶", "RE": "üá∑üá™", "RO": "üá∑üá¥", "RU": "üá∑üá∫", "RW": "üá∑üáº",
  "BL": "üáßüá±", "SH": "üá∏üá≠", "KN": "üá∞üá≥", "LC": "üá±üá®", "MF": "üá≤üá´",
  "PM": "üáµüá≤", "VC": "üáªüá®", "WS": "üáºüá∏", "SM": "üá∏üá≤", "ST": "üá∏üáπ",
  "SA": "üá∏üá¶", "SN": "üá∏üá≥", "RS": "üá∑üá∏", "SC": "üá∏üá®", "SL": "üá∏üá±",
  "SG": "üá∏üá¨", "SX": "üá∏üáΩ", "SK": "üá∏üá∞", "SI": "üá∏üáÆ", "SB": "üá∏üáß",
  "SO": "üá∏üá¥", "ZA": "üáøüá¶", "GS": "üá¨üá∏", "SS": "üá∏üá∏", "ES": "üá™üá∏",
  "LK": "üá±üá∞", "SD": "üá∏üá©", "SR": "üá∏üá∑", "SJ": "üá∏üáØ", "SE": "üá∏üá™",
  "CH": "üá®üá≠", "SY": "üá∏üáæ", "TW": "üáπüáº", "TJ": "üáπüáØ", "TZ": "üáπüáø",
  "TH": "üáπüá≠", "TL": "üáπüá±", "TG": "üáπüá¨", "TK": "üáπüá∞", "TO": "üáπüá¥",
  "TT": "üáπüáπ", "TN": "üáπüá≥", "TR": "üáπüá∑", "TM": "üáπüá≤", "TC": "üáπüá®",
  "TV": "üáπüáª", "UG": "üá∫üá¨", "UA": "üá∫üá¶", "AE": "üá¶üá™", "GB": "üá¨üáß",
  "US": "üá∫üá∏", "UM": "üá∫üá≤", "UY": "üá∫üáæ", "UZ": "üá∫üáø", "VU": "üáªüá∫",
  "VE": "üáªüá™", "VN": "üáªüá≥", "VI": "üáªüáÆ", "WF": "üáºüá´", "EH": "üá™üá≠",
  "YE": "üáæüá™", "ZM": "üáøüá≤", "ZW": "üáøüáº"
  };
  return flags[countryCode] || 'üè≥Ô∏è';
}

function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  if (!toast) return;
  toast.textContent = message;
  toast.className = `toast ${type} show`;
  setTimeout(() => toast.classList.remove('show'), 3000);
}

function updatePageTitle() {
  const pageTitle = document.getElementById('page-title');
  const catCount = document.getElementById('cat-count');
  
  if (CatalogueApp.state.filters.category) {
    const category = BRANDIA_CATEGORIES.find(c => c.slug === CatalogueApp.state.filters.category);
    if (category) {
      pageTitle.textContent = category.name;
      document.title = `${category.name} - Brandia`;
    }
  } else {
    pageTitle.textContent = 'Catalogue';
    document.title = 'Catalogue - Brandia';
  }
  
  if (catCount) catCount.textContent = BRANDIA_CATEGORIES.length;
}

function initCountrySelector() {
  const selector = document.getElementById('countrySelector');
  if (!selector) return;
  
  const savedCountry = localStorage.getItem('country') || 'FR';
  selector.innerHTML = '';
  
  const sortedCountries = Object.entries(COUNTRIES).sort((a, b) => a[1].name.localeCompare(b[1].name));
  
  sortedCountries.forEach(([code, country]) => {
    const option = document.createElement('option');
    option.value = code;
    option.textContent = `${getFlagEmoji(code)} ${country.name}`;
    if (code === savedCountry) option.selected = true;
    selector.appendChild(option);
  });
  
  selector.addEventListener('change', (e) => {
    localStorage.setItem('country', e.target.value);
    localStorage.setItem('currency', COUNTRIES[e.target.value].currency);
  });
}

function initFilters() {
  const urlParams = new URLSearchParams(window.location.search);
  let rawCategory = urlParams.get('category');
  
  if (!rawCategory || rawCategory === 'null' || rawCategory === 'undefined' || rawCategory === 'all' || rawCategory === '') {
    rawCategory = null;
  }
  
  CatalogueApp.state.filters.category = rawCategory;
  
  console.log('[initFilters] Cat√©gorie initiale:', rawCategory);
  
  const container = document.getElementById('filter-categories');
  if (container) {
    container.innerHTML = BRANDIA_CATEGORIES.map(cat => {
      const isSelected = rawCategory === cat.slug;
      return `
        <label class="flex items-center space-x-2 cursor-pointer hover:bg-neutral-700/50 p-2 rounded transition ${isSelected ? 'bg-neutral-700/30' : ''}">
          <input type="radio" name="category" value="${cat.slug}" class="checkbox-custom category-radio" ${isSelected ? 'checked' : ''} onchange="updateCategory('${cat.slug}')">
          <span class="text-sm text-neutral-300">${cat.name}</span>
        </label>
      `;
    }).join('');
    
    const allSelected = rawCategory === null;
    const allOption = `
      <label class="flex items-center space-x-2 cursor-pointer hover:bg-neutral-700/50 p-2 rounded transition ${allSelected ? 'bg-neutral-700/30' : ''}">
        <input type="radio" name="category" value="" class="checkbox-custom category-radio" ${allSelected ? 'checked' : ''} onchange="updateCategory(null)">
        <span class="text-sm text-neutral-300 font-medium">Toutes les cat√©gories</span>
      </label>
      <div class="border-t border-neutral-700 my-2"></div>
    `;
    container.innerHTML = allOption + container.innerHTML;
  }

  const dropdown = document.getElementById('dropdown-categories-list');
  if (dropdown) {
    dropdown.innerHTML = BRANDIA_CATEGORIES.map(cat => `
      <a href="catalogue.html?category=${encodeURIComponent(cat.slug)}" class="flex items-center gap-3 px-4 py-3 text-sm text-neutral-300 hover:text-white hover:bg-neutral-700 rounded-lg transition-colors mx-2 mb-1">
        <div class="w-8 h-8 bg-gradient-to-br ${cat.gradient} rounded-lg flex items-center justify-center flex-shrink-0">
          <i class="fas ${cat.icon} text-white text-xs"></i>
        </div>
        <span class="font-medium truncate">${cat.name}</span>
      </a>
    `).join('');
  }
  
  updatePageTitle();
}

function updateCategory(slug) {
  console.log('[updateCategory] Slug re√ßu:', slug);
  
  let cleanSlug = slug;
  if (!slug || slug === 'null' || slug === 'undefined' || slug === 'all' || slug === '') {
    cleanSlug = null;
  }
  
  console.log('[updateCategory] Clean slug:', cleanSlug);
  
  CatalogueApp.state.filters.category = cleanSlug;
  
  document.querySelectorAll('input[name="category"]').forEach(radio => {
    const label = radio.closest('label');
    if (!label) return;
    
    if (cleanSlug === null) {
      radio.checked = false;
      label.classList.remove('bg-neutral-700/30');
    } else {
      const isMatch = radio.value === cleanSlug;
      radio.checked = isMatch;
      label.classList.toggle('bg-neutral-700/30', isMatch);
    }
  });
  
  console.log('[updateCategory] Rechargement API avec category:', cleanSlug);
  CatalogueApp.loadProducts();
  
  if (cleanSlug) {
    window.history.replaceState({}, '', `?category=${encodeURIComponent(cleanSlug)}`);
    document.title = `${BRANDIA_CATEGORIES.find(c => c.slug === cleanSlug)?.name || 'Catalogue'} - Brandia`;
  } else {
    window.history.replaceState({}, '', window.location.pathname);
    document.title = 'Catalogue - Brandia';
  }
  
  const pageTitle = document.getElementById('page-title');
  if (pageTitle) {
    if (cleanSlug) {
      const cat = BRANDIA_CATEGORIES.find(c => c.slug === cleanSlug);
      pageTitle.textContent = cat?.name || 'Catalogue';
    } else {
      pageTitle.textContent = 'Catalogue';
    }
  }
}

function initSearch() {
  const searchInput = document.getElementById('search-input');
  const mobileSearch = document.getElementById('mobile-search');
  let timeout;
  
  const handleSearch = (e) => {
    clearTimeout(timeout);
    timeout = setTimeout(() => {
      CatalogueApp.state.filters.search = e.target.value;
      CatalogueApp.applyFilters();
    }, 400);
  };
  
  if (searchInput) searchInput.addEventListener('input', handleSearch);
  if (mobileSearch) mobileSearch.addEventListener('input', handleSearch);
}

function initAuth() {
  if (typeof BrandiaAPI === 'undefined') return;
  const user = BrandiaAPI.Auth.getUser();
  const authButtons = document.getElementById('auth-buttons');
  const userMenu = document.getElementById('user-menu');
  
  if (user && user.email) {
    authButtons?.classList.add('hidden');
    userMenu?.classList.remove('hidden');
    userMenu?.classList.add('flex');
    const userName = document.getElementById('user-name');
    if (userName) userName.textContent = user.first_name || user.email;
  }
}

function applyPrice() {
  CatalogueApp.state.filters.minPrice = parseFloat(document.getElementById('price-min').value) || null;
  CatalogueApp.state.filters.maxPrice = parseFloat(document.getElementById('price-max').value) || null;
  CatalogueApp.applyFilters();
}

function resetPrice() {
  document.getElementById('price-min').value = '';
  document.getElementById('price-max').value = '';
  CatalogueApp.state.filters.minPrice = null;
  CatalogueApp.state.filters.maxPrice = null;
  CatalogueApp.applyFilters();
}

function resetAll() {
  CatalogueApp.state.filters = {
    category: null,
    search: '',
    minPrice: null,
    maxPrice: null,
    promoOnly: false
  };
  CatalogueApp.state.sortBy = 'newest';
  
  document.getElementById('search-input').value = '';
  if (document.getElementById('mobile-search')) {
    document.getElementById('mobile-search').value = '';
  }
  document.getElementById('promo-only').checked = false;
  document.getElementById('sort-select').value = 'newest';
  
  document.querySelectorAll('input[name="category"]').forEach(radio => {
    radio.checked = false;
    radio.closest('label')?.classList.remove('bg-neutral-700/30');
  });
  
  window.history.replaceState({}, '', window.location.pathname);
  
  updatePageTitle();
  CatalogueApp.loadProducts();
}

function updateCartBadge() {
  try {
    const cart = JSON.parse(localStorage.getItem('brandia_cart') || '[]');
    const count = cart.reduce((sum, item) => sum + (item.quantity || 0), 0);
    const badge = document.getElementById('cart-count');
    if (badge) {
      badge.textContent = count;
      badge.classList.toggle('hidden', count === 0);
    }
  } catch (e) {
    console.error('Erreur badge:', e);
  }
}

// Initialisation
document.addEventListener('DOMContentLoaded', () => {
  console.log('[Catalogue] Initialisation avec promotions');
  CatalogueApp.init();
});
</script>
</body>
</html>