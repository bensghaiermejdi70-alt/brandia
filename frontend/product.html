<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produit ‚Äì Brandia</title>
  <meta name="description" content="D√©couvrez ce produit sur Brandia">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõçÔ∏è</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="assets/js/api.js"></script>
  <style>
    body { background-color: #0b111e; color: #f3f4f6; font-family: system-ui, sans-serif; }
    .container { max-width: 1200px; margin: auto; padding: 0 1rem; }
    .gallery-thumb { cursor: pointer; opacity: 0.6; transition: all 0.2s; border: 2px solid transparent; }
    .gallery-thumb:hover, .gallery-thumb.active { opacity: 1; border-color: #6366f1; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .review-star { color: #fbbf24; }
    .quantity-btn { transition: all 0.2s; }
    .quantity-btn:hover { background-color: #374151; }
    .skeleton { background: linear-gradient(90deg, #1f2937 25%, #374151 50%, #1f2937 75%); background-size: 200% 100%; animation: skeleton 1.5s infinite; }
    @keyframes skeleton { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; border-radius: 8px; color: white; font-weight: 500; z-index: 1000; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: #10b981; }
    .toast.error { background: #ef4444; }
  </style>
</head>
<body>

<header class="sticky top-0 z-50 bg-neutral-900/80 backdrop-blur border-b border-neutral-800">
  <nav class="container flex items-center justify-between px-4 py-3">
    <a href="index.html" class="flex items-center space-x-3">
      <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded flex items-center justify-center">
        <i class="fas fa-store text-white text-sm"></i>
      </div>
      <span class="font-bold text-lg text-neutral-100">Brandia</span>
    </a>
    <div class="hidden md:flex items-center space-x-6 text-sm text-neutral-300">
      <a href="catalogue.html?filter=new" class="hover:text-white">Nouveaut√©s</a>
      <a href="marques.html" class="hover:text-white">Marques</a>
      <a href="offres.html" class="hover:text-white">Offres</a>
      <a href="categories.html" class="hover:text-white">Cat√©gories</a>
    </div>
    <div class="flex items-center space-x-3">
      <select id="countrySelector" class="px-2 py-1 bg-neutral-800 rounded text-xs text-neutral-300 border border-neutral-700 focus:border-indigo-500 outline-none min-w-[120px]">
        <option value="FR">üá´üá∑ France</option>
        <option value="BE">üáßüá™ Belgique</option>
        <option value="CA">üá®üá¶ Canada</option>
        <option value="TN">üáπüá≥ Tunisie</option>
      </select>
      
      <div id="auth-buttons" class="flex items-center space-x-2">
        <a href="login.html" class="text-sm text-neutral-300 hover:text-white">Connexion</a>
        <a href="register.html" class="px-3 py-1 bg-indigo-500 hover:bg-indigo-400 text-white text-sm rounded transition">S'inscrire</a>
      </div>
      
      <div id="user-menu" class="hidden items-center space-x-3">
        <span id="user-name" class="text-sm text-neutral-300"></span>
        <button onclick="BrandiaAPI.Auth.logout()" class="text-sm text-red-400 hover:text-red-300">D√©connexion</button>
      </div>

      <a href="panier.html" class="relative">
        <i class="fas fa-shopping-bag text-neutral-300"></i>
        <span id="cart-count" class="absolute -top-1 -right-1 bg-indigo-500 text-xs rounded-full w-4 h-4 flex items-center justify-center text-white hidden">0</span>
      </a>
    </div>
  </nav>
</header>

<section class="border-b border-neutral-800 bg-neutral-900/30">
  <div class="container px-4 py-3">
    <div class="flex items-center text-sm text-neutral-400">
      <a href="index.html" class="hover:text-white">Accueil</a>
      <i class="fas fa-chevron-right text-xs mx-2"></i>
      <a href="catalogue.html" class="hover:text-white">Catalogue</a>
      <i class="fas fa-chevron-right text-xs mx-2"></i>
      <span id="breadcrumb-category" class="text-neutral-500">Chargement...</span>
    </div>
  </div>
</section>

<section class="py-8">
  <div class="container px-4">
    <div id="loading-state" class="text-center py-12">
      <i class="fas fa-spinner fa-spin text-indigo-400 text-3xl"></i>
      <p class="text-neutral-400 mt-4">Chargement du produit...</p>
    </div>

    <div id="product-content" class="hidden grid lg:grid-cols-2 gap-8">
      <div class="space-y-4">
        <div class="relative aspect-square bg-neutral-800 rounded-lg overflow-hidden">
          <img id="main-image" src="" alt="Produit" class="w-full h-full object-cover fade-in">
          <button onclick="toggleZoom()" class="absolute bottom-4 right-4 p-2 bg-neutral-900/80 rounded-lg text-white hover:bg-neutral-800 transition">
            <i class="fas fa-expand"></i>
          </button>
        </div>
        <div class="flex gap-2 overflow-x-auto pb-2" id="gallery-thumbs"></div>
      </div>

      <div class="space-y-6">
        <div>
          <div class="flex items-center gap-2 mb-2">
            <span id="product-category" class="text-xs text-indigo-400 uppercase tracking-wider">Cat√©gorie</span>
            <span id="product-badge" class="hidden px-2 py-0.5 bg-emerald-500/20 text-emerald-400 text-xs rounded">Nouveau</span>
          </div>
          <h1 id="product-name" class="text-3xl font-bold text-white mb-2">Nom du produit</h1>
          <div class="flex items-center gap-4 mb-4">
            <div class="flex items-center gap-1" id="product-rating"></div>
            <span id="review-count" class="text-sm text-neutral-400">0 avis</span>
            <span class="text-neutral-600">|</span>
            <span id="product-sku" class="text-sm text-neutral-500">REF: ---</span>
          </div>
        </div>

        <div class="flex items-baseline gap-3">
          <span id="product-price" class="text-4xl font-bold text-indigo-400">-- ‚Ç¨</span>
          <span id="product-old-price" class="hidden text-xl text-neutral-500 line-through">-- ‚Ç¨</span>
          <span id="product-discount" class="hidden px-2 py-1 bg-red-500/20 text-red-400 text-sm rounded">-0%</span>
        </div>

        <p id="product-short-desc" class="text-neutral-300 leading-relaxed">Description du produit...</p>

        <div class="flex items-center gap-6 text-sm">
          <div class="flex items-center gap-2" id="stock-status">
            <i class="fas fa-check-circle text-emerald-400"></i>
            <span class="text-emerald-400">En stock</span>
          </div>
          <div class="flex items-center gap-2 text-neutral-400">
            <i class="fas fa-truck"></i>
            <span>Livraison 2-4 jours</span>
          </div>
        </div>

        <div class="flex items-center gap-4 pt-4 border-t border-neutral-800">
          <div class="flex items-center border border-neutral-700 rounded-lg bg-neutral-900">
            <button onclick="updateQty(-1)" class="quantity-btn px-4 py-2 text-neutral-400 hover:text-white rounded-l-lg">
              <i class="fas fa-minus"></i>
            </button>
            <span id="quantity" class="px-4 py-2 font-semibold min-w-[3rem] text-center">1</span>
            <button onclick="updateQty(1)" class="quantity-btn px-4 py-2 text-neutral-400 hover:text-white rounded-r-lg">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          
          <button onclick="addToCart()" id="btn-add-cart" class="flex-1 px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold rounded-lg transition flex items-center justify-center gap-2">
            <i class="fas fa-shopping-cart"></i>
            <span>Ajouter au panier</span>
          </button>
          
          <button onclick="toggleWishlist()" id="btn-wishlist" class="p-3 border border-neutral-700 rounded-lg text-neutral-400 hover:text-pink-400 hover:border-pink-400/50 transition">
            <i class="far fa-heart text-xl"></i>
          </button>
        </div>

        <div class="bg-neutral-800/50 rounded-lg p-4 border border-neutral-700">
          <h3 class="font-semibold text-white mb-2">Description compl√®te</h3>
          <div id="product-description" class="text-neutral-300 text-sm leading-relaxed space-y-2">
            Chargement...
          </div>
        </div>
      </div>
    </div>

    <div id="error-state" class="hidden text-center py-12">
      <i class="fas fa-exclamation-circle text-red-400 text-4xl mb-4"></i>
      <h2 class="text-xl font-bold text-white mb-2">Produit non trouv√©</h2>
      <p class="text-neutral-400 mb-4">Ce produit n'existe pas ou n'est plus disponible.</p>
      <a href="catalogue.html" class="inline-block px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg transition">
        Retour au catalogue
      </a>
    </div>
  </div>
</section>

<footer class="border-t border-neutral-800 py-10 bg-neutral-900 mt-12">
  <div class="container text-center text-neutral-500 text-sm">
    ¬© 2026 Brandia ‚Äì Marketplace officielle des marques
  </div>
</footer>

<div id="toast" class="toast"></div>

<script>
let currentProduct = null;
let currentQty = 1;

function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast ${type} show`;
  setTimeout(() => toast.classList.remove('show'), 3000);
}

function updateQty(delta) {
  const newQty = currentQty + delta;
  if (newQty < 1) return;
  if (currentProduct && newQty > currentProduct.stock_quantity) {
    showToast('Stock maximum atteint', 'error');
    return;
  }
  currentQty = newQty;
  document.getElementById('quantity').textContent = currentQty;
}

function toggleWishlist() {
  const btn = document.getElementById('btn-wishlist');
  const icon = btn.querySelector('i');
  if (icon.classList.contains('far')) {
    icon.classList.remove('far');
    icon.classList.add('fas', 'text-pink-400');
    showToast('Ajout√© aux favoris');
  } else {
    icon.classList.remove('fas', 'text-pink-400');
    icon.classList.add('far');
  }
}

function toggleZoom() {
  const img = document.getElementById('main-image');
  img.classList.toggle('scale-150');
  img.classList.toggle('cursor-zoom-out');
  if (img.classList.contains('scale-150')) {
    img.style.transform = 'scale(1.5)';
    img.style.cursor = 'zoom-out';
  } else {
    img.style.transform = 'scale(1)';
    img.style.cursor = 'default';
  }
}

async function loadProduct() {
  const urlParams = new URLSearchParams(window.location.search);
  const productId = urlParams.get('id');
  
  if (!productId) {
    showError();
    return;
  }

  try {
    const data = await BrandiaAPI.Products.getById(productId);
    
    if (!data.success || !data.product) {
      showError();
      return;
    }

    currentProduct = data.product;
    renderProduct(currentProduct);
    
  } catch (error) {
    console.error('Erreur:', error);
    showError();
  }
}

function renderProduct(p) {
  document.getElementById('loading-state').classList.add('hidden');
  document.getElementById('product-content').classList.remove('hidden');
  document.getElementById('product-content').classList.add('grid');

  document.getElementById('product-name').textContent = p.name;
  document.getElementById('product-category').textContent = p.category_name || p.category_slug || 'Cat√©gorie';
  document.getElementById('breadcrumb-category').textContent = p.category_name || p.category_slug || 'Produit';
  document.getElementById('product-sku').textContent = `REF: ${p.sku || `BRD-${p.id}`}`;
  document.getElementById('product-price').textContent = `${p.price.toFixed(2)} ‚Ç¨`;
  document.getElementById('product-short-desc').textContent = p.short_description || p.description?.substring(0, 150) + '...' || 'Aucune description disponible.';
  document.getElementById('product-description').innerHTML = p.description || '<p>Aucune description d√©taill√©e.</p>';
  
  const mainImage = document.getElementById('main-image');
  mainImage.src = p.main_image_url || 'https://images.unsplash.com/photo-1555529669-e69e7aa0ba9a?w=600&q=80';
  
  if (p.compare_at_price && p.compare_at_price > p.price) {
    document.getElementById('product-old-price').textContent = `${p.compare_at_price.toFixed(2)} ‚Ç¨`;
    document.getElementById('product-old-price').classList.remove('hidden');
    const discount = Math.round(((p.compare_at_price - p.price) / p.compare_at_price) * 100);
    document.getElementById('product-discount').textContent = `-${discount}%`;
    document.getElementById('product-discount').classList.remove('hidden');
  }
  
  const stockEl = document.getElementById('stock-status');
  if (p.stock_quantity > 0) {
    stockEl.innerHTML = `<i class="fas fa-check-circle text-emerald-400"></i><span class="text-emerald-400">En stock (${p.stock_quantity} disponibles)</span>`;
    document.getElementById('btn-add-cart').disabled = false;
  } else {
    stockEl.innerHTML = `<i class="fas fa-times-circle text-red-400"></i><span class="text-red-400">Rupture de stock</span>`;
    document.getElementById('btn-add-cart').disabled = true;
    document.getElementById('btn-add-cart').classList.add('opacity-50', 'cursor-not-allowed');
  }
  
  const rating = p.rating || 4;
  const stars = Array(5).fill(0).map((_, i) => 
    `<i class="${i < Math.floor(rating) ? 'fas' : 'far'} fa-star review-star"></i>`
  ).join('');
  document.getElementById('product-rating').innerHTML = stars;
  document.getElementById('review-count').textContent = `${p.reviews_count || 0} avis`;
  
  if (p.images && p.images.length > 1) {
    const thumbs = document.getElementById('gallery-thumbs');
    thumbs.innerHTML = p.images.map((img, idx) => `
      <img src="${img.url}" class="gallery-thumb w-20 h-20 object-cover rounded-lg ${idx === 0 ? 'active' : ''}" 
           onclick="changeImage('${img.url}', this)" onerror="this.style.display='none'">
    `).join('');
  }
}

function changeImage(url, thumb) {
  document.getElementById('main-image').src = url;
  document.querySelectorAll('.gallery-thumb').forEach(t => t.classList.remove('active'));
  thumb.classList.add('active');
}

function showError() {
  document.getElementById('loading-state').classList.add('hidden');
  document.getElementById('product-content').classList.add('hidden');
  document.getElementById('error-state').classList.remove('hidden');
}

function addToCart() {
  if (!currentProduct) return;
  
  for (let i = 0; i < currentQty; i++) {
    BrandiaAPI.Cart.add(currentProduct);
  }
  
  const btn = document.getElementById('btn-add-cart');
  const originalHTML = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-check"></i> Ajout√© !';
  btn.classList.add('bg-emerald-600');
  showToast(`${currentQty} √ó ${currentProduct.name} ajout√©(s) au panier`);
  
  setTimeout(() => {
    btn.innerHTML = originalHTML;
    btn.classList.remove('bg-emerald-600');
  }, 2000);
}

function initAuth() {
  const user = BrandiaAPI.Auth.getUser();
  const authButtons = document.getElementById('auth-buttons');
  const userMenu = document.getElementById('user-menu');
  const userName = document.getElementById('user-name');
  
  if (user && user.email) {
    authButtons?.classList.add('hidden');
    userMenu?.classList.remove('hidden');
    userMenu?.classList.add('flex');
    if (userName) userName.textContent = user.first_name || user.email;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  loadProduct();
  initAuth();
  BrandiaAPI.Cart.updateBadge();
});
</script>
</body>
</html>