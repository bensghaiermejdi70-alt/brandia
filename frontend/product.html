<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produit - Brandia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="assets/js/api.js"></script>
  <script src="assets/js/brandia-ads.js"></script>
  <style>
    body { background-color: #0b111e; color: #f3f4f6; font-family: system-ui, sans-serif; }
    .container { max-width: 1200px; margin: auto; padding: 0 1rem; }
    .gallery-thumb { cursor: pointer; opacity: 0.6; transition: all 0.2s; border: 2px solid transparent; }
    .gallery-thumb:hover, .gallery-thumb.active { opacity: 1; border-color: #6366f1; }
    .zoom-container { overflow: hidden; cursor: zoom-in; }
    .zoom-container img { transition: transform 0.3s ease; }
    .zoom-container:hover img { transform: scale(1.15); }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; border-radius: 8px; color: white; font-weight: 500; z-index: 1000; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: #10b981; }
    .toast.error { background: #ef4444; }
    .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
  </style>
</head>
<body>

<header class="sticky top-0 z-40 bg-neutral-900/95 backdrop-blur border-b border-neutral-800">
  <nav class="container flex items-center justify-between px-4 py-3">
    <a href="index.html" class="flex items-center space-x-3">
      <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded flex items-center justify-center">
        <i class="fas fa-store text-white text-sm"></i>
      </div>
      <span class="font-bold text-lg text-neutral-100">Brandia</span>
    </a>
    
    <div class="hidden md:flex items-center space-x-6 text-sm text-neutral-300">
      <a href="catalogue.html" class="hover:text-white transition">Catalogue</a>
      <a href="index.html" class="hover:text-white transition">Accueil</a>
      <a href="offres.html" class="hover:text-white transition">Offres</a>
    </div>

    <div class="flex items-center space-x-3">
      <select id="countrySelector" class="px-2 py-1 bg-neutral-800 rounded text-xs text-neutral-300 border border-neutral-700">
        <option value="">Chargement...</option>
      </select>
      
      <div id="auth-buttons" class="flex items-center space-x-2">
        <a href="login.html" class="text-sm text-neutral-300 hover:text-white">Connexion</a>
      </div>
      
      <div id="user-menu" class="hidden items-center space-x-3">
        <span id="user-name" class="text-sm text-neutral-300"></span>
        <button onclick="logout()" class="text-sm text-red-400 hover:text-red-300">D√©connexion</button>
      </div>

      <a href="panier.html" class="relative">
        <i class="fas fa-shopping-bag text-neutral-300"></i>
        <span id="cart-count" class="absolute -top-1 -right-1 bg-indigo-500 text-xs rounded-full w-4 h-4 flex items-center justify-center text-white hidden">0</span>
      </a>
    </div>
  </nav>
</header>

<section class="border-b border-neutral-800 bg-neutral-900/30">
  <div class="container px-4 py-3">
    <div class="flex items-center text-sm text-neutral-400">
      <a href="index.html" class="hover:text-white">Accueil</a>
      <i class="fas fa-chevron-right text-xs mx-2"></i>
      <a href="catalogue.html" class="hover:text-white">Catalogue</a>
      <i class="fas fa-chevron-right text-xs mx-2"></i>
      <span id="breadcrumb-product" class="text-neutral-500">Produit</span>
    </div>
  </div>
</section>

<div id="loading-state" class="container px-4 py-20 text-center">
  <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500 mb-4"></div>
  <p class="text-neutral-400">Chargement du produit...</p>
</div>

<div id="error-state" class="hidden container px-4 py-20 text-center fade-in">
  <div class="w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
    <i class="fas fa-exclamation-triangle text-red-400 text-3xl"></i>
  </div>
  <h2 class="text-2xl font-bold text-white mb-2">Produit non disponible</h2>
  <p class="text-neutral-400 mb-6">Ce produit n'existe pas ou est temporairement indisponible.</p>
  <a href="catalogue.html" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg transition">
    Voir le catalogue
  </a>
</div>

<div id="product-content" class="hidden container px-4 py-8 fade-in">
  <div class="grid lg:grid-cols-2 gap-8">
    <div class="space-y-4">
      <div class="relative aspect-square bg-neutral-800 rounded-xl overflow-hidden zoom-container">
        <img id="main-image" src="" alt="" class="w-full h-full object-cover">
        <div id="stock-badge" class="absolute top-4 left-4 px-3 py-1 rounded-full text-xs font-bold bg-emerald-500/20 text-emerald-400 border border-emerald-500/30">
          En stock
        </div>
      </div>
      <div class="flex gap-3 overflow-x-auto pb-2" id="gallery-thumbs"></div>
    </div>

    <div class="space-y-6">
      <div>
        <div class="flex items-center gap-3 mb-3 flex-wrap">
          <span id="product-category" class="px-3 py-1 bg-indigo-500/20 text-indigo-400 text-xs font-bold uppercase rounded-full">Cat√©gorie</span>
          <span id="product-brand" class="px-3 py-1 bg-slate-700 text-slate-300 text-xs font-bold rounded-full hidden"></span>
        </div>
        <h1 id="product-name" class="text-3xl md:text-4xl font-bold text-white mb-3">Nom du produit</h1>
        <div class="flex items-center gap-4 mb-4 flex-wrap">
          <div class="flex items-center gap-1 text-yellow-400" id="product-rating"></div>
          <span id="review-count" class="text-sm text-neutral-400">0 avis</span>
          <span class="text-neutral-600">|</span>
          <span id="product-sku" class="text-sm text-neutral-500 font-mono">REF: ---</span>
        </div>
      </div>

      <div class="flex items-baseline gap-4 flex-wrap">
        <span id="product-price" class="text-4xl font-bold text-white">-- ‚Ç¨</span>
        <span id="product-old-price" class="hidden text-2xl text-neutral-500 line-through">-- ‚Ç¨</span>
        <span id="product-discount" class="hidden px-3 py-1 bg-red-500/20 text-red-400 text-sm font-bold rounded-full">-0%</span>
      </div>

      <p id="product-description" class="text-neutral-300 leading-relaxed text-lg">Description...</p>

      <div class="flex items-center gap-4 pt-4">
        <div class="flex items-center border border-neutral-700 rounded-lg bg-neutral-900">
          <button onclick="updateQty(-1)" class="px-4 py-3 text-neutral-400 hover:text-white w-12">
            <i class="fas fa-minus"></i>
          </button>
          <span id="quantity" class="px-4 py-2 font-bold text-lg min-w-[3rem] text-center">1</span>
          <button onclick="updateQty(1)" class="px-4 py-3 text-neutral-400 hover:text-white w-12">
            <i class="fas fa-plus"></i>
          </button>
        </div>
        
        <button onclick="addToCart()" id="btn-add-cart" class="flex-1 btn-primary px-8 py-3 text-white font-bold rounded-lg transition flex items-center justify-center gap-2">
          <i class="fas fa-shopping-cart"></i>
          <span>Ajouter au panier</span>
        </button>
      </div>

      <div id="stock-info" class="flex items-center gap-2 text-sm text-emerald-400">
        <i class="fas fa-check-circle"></i>
        <span>En stock - Livraison 2-4 jours</span>
      </div>

      <div class="grid grid-cols-3 gap-4 pt-6 border-t border-neutral-800">
        <div class="text-center">
          <i class="fas fa-truck text-indigo-400 text-2xl mb-2"></i>
          <p class="text-xs text-neutral-400">Livraison gratuite d√®s 50‚Ç¨</p>
        </div>
        <div class="text-center">
          <i class="fas fa-shield-alt text-indigo-400 text-2xl mb-2"></i>
          <p class="text-xs text-neutral-400">Paiement s√©curis√©</p>
        </div>
        <div class="text-center">
          <i class="fas fa-undo text-indigo-400 text-2xl mb-2"></i>
          <p class="text-xs text-neutral-400">Retour sous 14 jours</p>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-12 pt-8 border-t border-neutral-800">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-bold text-white">Vendu par <span id="supplier-name-display">...</span></h3>
      <a href="#" id="supplier-link" class="text-indigo-400 hover:text-indigo-300 text-sm">Voir la boutique <i class="fas fa-arrow-right ml-1"></i></a>
    </div>
    <div class="bg-neutral-900 rounded-xl p-6 border border-neutral-800">
      <div class="flex items-start gap-4">
        <div id="supplier-initial" class="w-16 h-16 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-2xl font-bold text-white">
          B
        </div>
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-2">
            <h4 class="font-semibold text-lg" id="supplier-name-full">Marque</h4>
            <span class="px-2 py-0.5 bg-emerald-500/20 text-emerald-400 text-xs rounded-full">V√©rifi√©</span>
          </div>
          <p class="text-neutral-400 text-sm mb-3" id="supplier-description">Description du vendeur...</p>
          <div class="flex items-center gap-4 text-sm text-neutral-500">
            <span><i class="fas fa-star text-yellow-400 mr-1"></i> <span id="supplier-rating">4.8</span></span>
            <span><i class="fas fa-map-marker-alt text-red-400 mr-1"></i> <span id="supplier-location">France</span></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<footer class="border-t border-neutral-800 py-10 bg-neutral-900 mt-12 text-center text-neutral-500 text-sm">
  <div class="container">
    <p>¬© 2026 Brandia ‚Äì Marketplace officielle des marques</p>
  </div>
</footer>

<div id="toast" class="toast"></div>

<script>
const COUNTRIES = { FR:{name:'France',currency:'EUR'},DE:{name:'Allemagne',currency:'EUR'},IT:{name:'Italie',currency:'EUR'},ES:{name:'Espagne',currency:'EUR'},TN:{name:'Tunisie',currency:'TND'},DZ:{name:'Alg√©rie',currency:'DZD'},MA:{name:'Maroc',currency:'MAD'},BE:{name:'Belgique',currency:'EUR'},CH:{name:'Suisse',currency:'CHF'},CA:{name:'Canada',currency:'CAD'},US:{name:'√âtats-Unis',currency:'USD'},GB:{name:'Royaume-Uni',currency:'GBP'} };

let currentProduct = null;
let currentQty = 1;
let currentSupplierId = null;

function showToast(msg, type='success'){const t=document.getElementById('toast');t.textContent=msg;t.className=`toast ${type} show`;setTimeout(()=>t.classList.remove('show'),3000);}
function updateQty(delta){const newQty=currentQty+delta;if(newQty<1)return;if(currentProduct&&newQty>(currentProduct.stock_quantity||999)){showToast('Stock maximum atteint','warning');return}currentQty=newQty;document.getElementById('quantity').textContent=currentQty;}

// ==========================================
// FONCTION CRITIQUE CORRIG√âE
// ==========================================
async function loadProduct(){
  const urlParams=new URLSearchParams(window.location.search);
  const productId=urlParams.get('id');
  console.log('[Product] Loading ID:',productId);
  if(!productId){console.error('[Product] No ID in URL');showError();return}
  try{
    if(typeof BrandiaAPI==='undefined'){throw new Error('BrandiaAPI not loaded')}
    
    let product=null;
    try{
      const promoData=await BrandiaAPI.Products.getByIdWithPromotion(productId);
      if(promoData?.success&&promoData.data){product=promoData.data.product||promoData.data}
    }catch(e){console.warn('[Product] Promo API failed:',e.message)}
    
    if(!product){
      const res=await fetch(`${BrandiaAPI.config.apiURL}/products/${productId}`);
      const data=await res.json();
      if(data?.success&&data.data){product=data.data.product||data.data}
    }
    
    if(!product||!product.id){throw new Error('Product not found in any API')}
    
    currentProduct=product;
    currentSupplierId=product.supplier_id||product.supplier?.id||product.user_id;
    
    renderProduct(product);
    
    // üî•üî•üî• AJOUT CRITIQUE : Exposer pour publicit√©
    window.currentProduct={id:product.id,supplier_id:currentSupplierId};
    console.log('[Product] Exposed for ads:',window.currentProduct);
    
    // üî•üî•üî• D√âCLENCHER LA PUBLICIT√â
    setTimeout(()=>{
      if(window.brandiaAds&&currentSupplierId){console.log('[Product] Triggering ad check...');window.brandiaAds.checkAndShow(product.id,currentSupplierId)}
      else{console.warn('[Product] brandiaAds not ready, retrying...');setTimeout(()=>{if(window.brandiaAds&&currentSupplierId){window.brandiaAds.checkAndShow(product.id,currentSupplierId)}},1000)}
    },2000);
    
  }catch(err){console.error('[Product] Fatal error:',err);showError()}
}

function showError(){document.getElementById('loading-state').classList.add('hidden');document.getElementById('error-state').classList.remove('hidden');}
function renderProduct(p){/* ... code de rendu identique √† ton fichier original ... */}

// ... autres fonctions : changeImage, addToCart, updateCartBadge, formatPrice, initCountries, initAuth, logout ...

document.addEventListener('DOMContentLoaded',()=>{
  initCountries();
  initAuth();
  updateCartBadge();
  loadProduct();
});

// ==========================================
// D√âCLENCHEMENT PUBLICIT√â (BACKUP)
// ==========================================
document.addEventListener('DOMContentLoaded',function(){
  setTimeout(function checkAndTriggerAd(){
    if(window.currentProduct?.supplier_id && window.brandiaAds){
      console.log('[Product] Backup trigger for ad');
      window.brandiaAds.checkAndShow(window.currentProduct.id,window.currentProduct.supplier_id);
    } else {
      console.log('[Product] Waiting for product/ads...');
      setTimeout(checkAndTriggerAd,1000);
    }
  },3000);
});
</script>

</body>
</html>
