<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produit - Brandia</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* Styles de base */
    body {
      font-family: system-ui, -apple-system, sans-serif;
    }
    
    /* Animation pulse pour badges */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    /* Styles pour la publicitÃ© contextuelle */
    .brandia-ad-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .brandia-ad-overlay.active {
      display: flex;
    }
    
    .brandia-ad-container {
      position: relative;
      width: 100%;
      max-width: 600px;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      animation: adSlideIn 0.4s ease-out;
    }
    
    @keyframes adSlideIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .brandia-ad-media {
      width: 100%;
      height: 300px;
      object-fit: cover;
      background: #0f172a;
    }
    
    .brandia-ad-video {
      width: 100%;
      height: 300px;
      object-fit: cover;
      background: #000;
    }
    
    .brandia-ad-content {
      padding: 24px;
    }
    
    .brandia-ad-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 40px;
      height: 40px;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 10;
    }
    
    .brandia-ad-close:hover {
      background: rgba(239, 68, 68, 0.9);
      transform: scale(1.1);
    }
    
    .brandia-ad-timer {
      position: absolute;
      top: 16px;
      left: 16px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .brandia-ad-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 4px;
      background: linear-gradient(90deg, #ec4899, #8b5cf6);
      transition: width 1s linear;
    }
    
    .brandia-ad-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #ec4899, #8b5cf6);
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    
    .brandia-ad-headline {
      font-size: 22px;
      font-weight: 700;
      color: white;
      margin-bottom: 8px;
      line-height: 1.3;
    }
    
    .brandia-ad-description {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    .brandia-ad-cta {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #ec4899, #8b5cf6);
      color: white;
      padding: 14px 28px;
      border-radius: 12px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s;
      border: none;
      cursor: pointer;
    }
    
    .brandia-ad-cta:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(236, 72, 153, 0.4);
    }
    
    .brandia-ad-footer {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 11px;
      color: #64748b;
      text-align: center;
    }
    
    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      color: white;
      font-weight: 500;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .toast.success {
      background: #10b981;
    }
    
    .toast.error {
      background: #ef4444;
    }
    
    /* Responsive */
    @media (max-width: 640px) {
      .brandia-ad-container {
        max-width: 100%;
        margin: 10px;
      }
      
      .brandia-ad-media,
      .brandia-ad-video {
        height: 200px;
      }
    }
  </style>
</head>
<body class="bg-slate-900 text-white min-h-screen">

  <!-- ========================================== -->
  <!-- HEADER -->
  <!-- ========================================== -->
  <header class="sticky top-0 z-40 bg-slate-900/95 backdrop-blur border-b border-slate-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <!-- Logo -->
        <a href="index.html" class="flex items-center gap-2">
          <div class="w-8 h-8 bg-gradient-to-br from-pink-500 to-violet-600 rounded-lg flex items-center justify-center">
            <span class="font-bold text-white text-sm">B</span>
          </div>
          <span class="font-bold text-xl bg-gradient-to-r from-white to-slate-400 bg-clip-text text-transparent">Brandia</span>
        </a>

        <!-- Navigation -->
        <nav class="hidden md:flex items-center gap-8">
          <a href="catalogue.html" class="text-slate-300 hover:text-white transition">Catalogue</a>
          <a href="categories.html" class="text-slate-300 hover:text-white transition">CatÃ©gories</a>
          <a href="marques.html" class="text-slate-300 hover:text-white transition">Marques</a>
        </nav>

        <!-- Actions -->
        <div class="flex items-center gap-4">
          <!-- SÃ©lecteur pays -->
          <select id="countrySelector" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-1.5 text-sm text-slate-300 focus:outline-none focus:border-pink-500">
            <option value="FR">ðŸ‡«ðŸ‡· France</option>
            <option value="TN">ðŸ‡¹ðŸ‡³ Tunisie</option>
            <option value="DE">ðŸ‡©ðŸ‡ª Allemagne</option>
            <option value="IT">ðŸ‡®ðŸ‡¹ Italie</option>
            <option value="ES">ðŸ‡ªðŸ‡¸ Espagne</option>
          </select>

          <!-- Panier -->
          <a href="panier.html" class="relative p-2 text-slate-300 hover:text-white transition">
            <i class="fas fa-shopping-cart text-xl"></i>
            <span id="cart-count" class="absolute -top-1 -right-1 w-5 h-5 bg-pink-500 rounded-full text-xs flex items-center justify-center font-bold hidden">0</span>
          </a>

          <!-- Auth -->
          <div id="auth-buttons">
            <a href="login.html" class="text-slate-300 hover:text-white transition text-sm">Connexion</a>
          </div>
          <div id="user-menu" class="hidden items-center gap-3">
            <span id="user-name" class="text-sm text-slate-300"></span>
            <button onclick="logout()" class="text-slate-400 hover:text-white transition">
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- ========================================== -->
  <!-- CONTENU PRODUIT -->
  <!-- ========================================== -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div id="product-container" class="grid grid-cols-1 lg:grid-cols-2 gap-12">
      <!-- Loading state -->
      <div class="col-span-full flex items-center justify-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500"></div>
        <span class="ml-4 text-slate-400">Chargement du produit...</span>
      </div>
    </div>
  </main>

  <!-- ========================================== -->
  <!-- PUBLICITÃ‰ CONTEXTUELLE BRANDIA -->
  <!-- ========================================== -->
  <div id="brandia-ad-overlay" class="brandia-ad-overlay">
    <div class="brandia-ad-container">
      <!-- Timer -->
      <div class="brandia-ad-timer">
        <i class="fas fa-clock"></i>
        <span id="ad-timer-text">15s</span>
      </div>
      
      <!-- Fermer -->
      <button class="brandia-ad-close" onclick="brandiaAds.close()" title="Fermer (Esc)">
        <i class="fas fa-times"></i>
      </button>
      
      <!-- MÃ©dia -->
      <div id="ad-media-container">
        <!-- Image ou vidÃ©o injectÃ©e ici -->
      </div>
      
      <!-- Progress bar -->
      <div class="brandia-ad-progress" id="ad-progress" style="width: 100%"></div>
      
      <!-- Contenu -->
      <div class="brandia-ad-content">
        <div class="brandia-ad-badge">
          <i class="fas fa-bullhorn"></i>
          Offre spÃ©ciale
        </div>
        
        <h3 id="ad-headline" class="brandia-ad-headline">Titre de la campagne</h3>
        <p id="ad-description" class="brandia-ad-description">Description de l'offre</p>
        
        <a id="ad-cta" href="#" class="brandia-ad-cta" target="_blank" onclick="brandiaAds.trackClick()">
          <span>Voir l'offre</span>
          <i class="fas fa-arrow-right"></i>
        </a>
        
        <div class="brandia-ad-footer">
          <i class="fas fa-info-circle mr-1"></i>
          Contenu proposÃ© par la marque que vous consultez
        </div>
      </div>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- FOOTER -->
  <!-- ========================================== -->
  <footer class="bg-slate-900 border-t border-slate-800 mt-20">
    <div class="max-w-7xl mx-auto px-4 py-8 text-center text-slate-500 text-sm">
      <p>&copy; 2026 Brandia. Tous droits rÃ©servÃ©s.</p>
    </div>
  </footer>

  <!-- ========================================== -->
  <!-- SCRIPTS -->
  <!-- ========================================== -->
  
  <!-- 1. API Client Brandia -->
  <script src="assets/js/api.js"></script>
  
  <!-- 2. SystÃ¨me de PublicitÃ© Contextuelle -->
  <script src="assets/js/brandia-ads.js"></script>
  
  <!-- 3. Logique Produit -->
  <script>
    // ==========================================
    // VARIABLE GLOBALE POUR LA PUBLICITÃ‰
    // ==========================================
    window.currentProduct = null;

    // ==========================================
    // CHARGEMENT PRODUIT (CORRIGÃ‰)
    // ==========================================
    async function loadProduct() {
      const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get('id');
      
      console.log('[Product] Loading ID:', productId);
      
      if (!productId || productId === 'null' || productId === 'undefined') {
        console.error('[Product] Invalid ID:', productId);
        showError('Produit non trouvÃ© - ID invalide');
        return;
      }

      const container = document.getElementById('product-container');
      
      try {
        // VÃ©rifier que BrandiaAPI est chargÃ©
        if (typeof BrandiaAPI === 'undefined') {
          throw new Error('API non chargÃ©e - VÃ©rifiez que api.js est bien inclus');
        }

        // Utiliser BrandiaAPI pour rÃ©cupÃ©rer le produit
        console.log('[Product] Calling API...');
        const response = await BrandiaAPI.Products.getByIdWithPromotion(productId);
        console.log('[Product] API Response:', response);
        
        if (!response.success) {
          throw new Error(response.message || 'Produit non trouvÃ©');
        }
        
        const productData = response.data?.product || response.data;
        if (!productData) {
          throw new Error('DonnÃ©es produit vides');
        }
        
        console.log('[Product] Product data:', productData);
        
        // EXPOSER POUR LA PUBLICITÃ‰ (CRITIQUE)
        window.currentProduct = {
          id: productData.id,
          supplier_id: productData.supplier_id || productData.supplier?.id || null,
          name: productData.name,
          category_id: productData.category_id
        };
        
        console.log('[Product] Exposed for ads:', window.currentProduct);

        // Rendu du produit
        renderProduct(productData);
        
        // DÃ‰CLENCHER LA PUBLICITÃ‰ APRÃˆS RENDU
        setTimeout(() => {
          triggerAdCheck();
        }, 2000);

      } catch (err) {
        console.error('[Product] Fatal error:', err);
        showError(err.message || 'Erreur lors du chargement du produit');
      }
    }

    // ==========================================
    // DÃ‰CLENCHEMENT PUBLICITÃ‰
    // ==========================================
    function triggerAdCheck() {
      console.log('[Product] Triggering ad check...');
      console.log('[Product] currentProduct:', window.currentProduct);
      console.log('[Product] brandiaAds exists:', !!window.brandiaAds);
      
      if (!window.currentProduct?.supplier_id) {
        console.warn('[Product] No supplier_id, skipping ad');
        return;
      }
      
      if (!window.brandiaAds) {
        console.warn('[Product] brandiaAds not loaded yet, retrying...');
        setTimeout(triggerAdCheck, 1000);
        return;
      }
      
      // VÃ©rifier si dÃ©jÃ  vue cette session
      const sessionKey = `ad_seen_${window.currentProduct.supplier_id}_${window.currentProduct.id}`;
      if (sessionStorage.getItem(sessionKey)) {
        console.log('[Product] Ad already seen this session');
        return;
      }
      
      // Lancer la vÃ©rification
      window.brandiaAds.checkAndShow(
        window.currentProduct.id, 
        window.currentProduct.supplier_id
      );
    }

    // ==========================================
    // RENDU PRODUIT COMPLET
    // ==========================================
    function renderProduct(product) {
      const container = document.getElementById('product-container');
      
      // Calcul prix avec promotion
      const hasPromo = product.has_promotion || product.promotion;
      const finalPrice = parseFloat(product.final_price || product.price);
      const originalPrice = hasPromo ? parseFloat(product.base_price || product.price) : null;
      const discount = hasPromo && originalPrice ? Math.round((1 - finalPrice/originalPrice) * 100) : 0;
      
      // Images
      const mainImage = product.main_image_url || product.image || 'https://images.unsplash.com/photo-1555529669-e69e7aa0ba9a?w=800';
      const gallery = product.gallery || [mainImage];
      
      // Fournisseur
      const supplier = product.supplier || {};
      const supplierName = supplier.company_name || supplier.name || product.brand_name || 'Marque partenaire';
      
      container.innerHTML = `
        <!-- Galerie Images -->
        <div class="space-y-4">
          <div class="aspect-square rounded-2xl overflow-hidden bg-slate-800 relative group">
            <img id="main-image" src="${mainImage}" 
                 class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                 alt="${product.name}"
                 onerror="this.src='https://images.unsplash.com/photo-1555529669-e69e7aa0ba9a?w=800'">
            ${hasPromo ? `
              <div class="absolute top-4 left-4 bg-gradient-to-r from-pink-500 to-rose-500 text-white px-4 py-2 rounded-full font-bold text-sm animate-pulse">
                -${discount}%
              </div>
            ` : ''}
          </div>
          
          ${gallery.length > 1 ? `
            <div class="grid grid-cols-4 gap-2">
              ${gallery.map((img, idx) => `
                <button onclick="changeMainImage('${img}')" 
                        class="aspect-square rounded-lg overflow-hidden border-2 ${idx === 0 ? 'border-pink-500' : 'border-slate-700'} hover:border-pink-400 transition bg-slate-800">
                  <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1555529669-e69e7aa0ba9a?w=200'">
                </button>
              `).join('')}
            </div>
          ` : ''}
        </div>

        <!-- Infos Produit -->
        <div class="space-y-6">
          <!-- Marque -->
          <div class="flex items-center gap-3">
            ${supplier.logo_url ? `
              <img src="${supplier.logo_url}" class="w-10 h-10 rounded-full object-cover border border-slate-700 bg-slate-800" onerror="this.style.display='none'">
            ` : '<div class="w-10 h-10 rounded-full bg-gradient-to-br from-pink-500 to-violet-600 flex items-center justify-center"><i class="fas fa-store text-white text-sm"></i></div>'}
            <div>
              <p class="text-sm text-slate-400">Vendu par</p>
              <a href="brand.html?id=${product.supplier_id}" class="text-pink-400 hover:text-pink-300 font-medium transition">
                ${supplierName}
              </a>
            </div>
          </div>

          <!-- Titre -->
          <h1 class="text-3xl md:text-4xl font-bold text-white leading-tight">
            ${product.name || 'Produit sans nom'}
          </h1>

          <!-- Prix -->
          <div class="flex items-baseline gap-4 flex-wrap">
            <span class="text-4xl font-bold text-white">
              ${formatPrice(finalPrice)}
            </span>
            ${hasPromo && originalPrice ? `
              <span class="text-xl text-slate-500 line-through">
                ${formatPrice(originalPrice)}
              </span>
              <span class="bg-emerald-500/20 text-emerald-400 px-3 py-1 rounded-full text-sm font-medium">
                Ã‰conomisez ${formatPrice(originalPrice - finalPrice)}
              </span>
            ` : ''}
          </div>

          <!-- Description -->
          <div class="prose prose-invert max-w-none">
            <p class="text-slate-300 leading-relaxed">
              ${product.description || 'Aucune description disponible pour ce produit.'}
            </p>
          </div>

          <!-- Stock -->
          <div class="flex items-center gap-2 ${product.stock > 0 ? 'text-emerald-400' : 'text-red-400'}">
            <i class="fas ${product.stock > 0 ? 'fa-check-circle' : 'fa-times-circle'}"></i>
            <span class="font-medium">
              ${product.stock > 0 ? `En stock (${product.stock} disponibles)` : 'Rupture de stock'}
            </span>
          </div>

          <!-- Actions -->
          <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-slate-800">
            <!-- QuantitÃ© -->
            <div class="flex items-center border border-slate-700 rounded-xl overflow-hidden bg-slate-800">
              <button onclick="updateQuantity(-1)" class="px-4 py-3 hover:bg-slate-700 transition text-slate-400">
                <i class="fas fa-minus"></i>
              </button>
              <input type="number" id="quantity" value="1" min="1" max="${product.stock || 1}" 
                     class="w-16 text-center bg-transparent border-x border-slate-700 py-3 text-white font-medium focus:outline-none"
                     onchange="validateQuantity(this)">
              <button onclick="updateQuantity(1)" class="px-4 py-3 hover:bg-slate-700 transition text-slate-400">
                <i class="fas fa-plus"></i>
              </button>
            </div>

            <!-- Ajouter au panier -->
            <button onclick="addToCart(${product.id})" 
                    class="flex-1 bg-gradient-to-r from-pink-500 to-violet-600 hover:from-pink-600 hover:to-violet-700 text-white font-bold py-3 px-8 rounded-xl transition transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3 shadow-lg shadow-pink-500/25"
                    ${product.stock <= 0 ? 'disabled' : ''}>
              <i class="fas fa-shopping-cart"></i>
              <span>${product.stock > 0 ? 'Ajouter au panier' : 'Indisponible'}</span>
            </button>

            <!-- Favoris -->
            <button class="p-3 border border-slate-700 rounded-xl hover:bg-slate-800 transition text-slate-400 hover:text-pink-500 bg-slate-800/50">
              <i class="far fa-heart text-xl"></i>
            </button>
          </div>

          <!-- Livraison -->
          <div class="bg-slate-800/50 rounded-xl p-4 space-y-3 border border-slate-700/50">
            <div class="flex items-center gap-3 text-sm text-slate-300">
              <i class="fas fa-truck text-pink-500"></i>
              <span>Livraison estimÃ©e: <strong class="text-white">3-5 jours ouvrÃ©s</strong></span>
            </div>
            <div class="flex items-center gap-3 text-sm text-slate-300">
              <i class="fas fa-shield-alt text-emerald-500"></i>
              <span>Paiement sÃ©curisÃ© par Stripe</span>
            </div>
            <div class="flex items-center gap-3 text-sm text-slate-300">
              <i class="fas fa-undo text-blue-500"></i>
              <span>Retours gratuits sous 14 jours</span>
            </div>
          </div>

          <!-- SKU -->
          <div class="text-xs text-slate-500 pt-4 border-t border-slate-800">
            RÃ©f: BRD-${String(product.id).padStart(6, '0')} | CatÃ©gorie: ${product.category_name || 'Non classÃ©'}
          </div>
        </div>
      `;
    }

    // ==========================================
    // FONCTIONS UTILITAIRES
    // ==========================================
    function changeMainImage(src) {
      const mainImg = document.getElementById('main-image');
      if (mainImg) {
        mainImg.style.opacity = '0.5';
        setTimeout(() => {
          mainImg.src = src;
          mainImg.style.opacity = '1';
        }, 200);
      }
    }

    function updateQuantity(delta) {
      const input = document.getElementById('quantity');
      if (!input) return;
      
      const current = parseInt(input.value) || 1;
      const max = parseInt(input.max) || 99;
      const newValue = Math.max(1, Math.min(max, current + delta));
      input.value = newValue;
    }

    function validateQuantity(input) {
      const max = parseInt(input.max) || 99;
      const value = parseInt(input.value) || 1;
      input.value = Math.max(1, Math.min(max, value));
    }

    async function addToCart(productId) {
      const quantityInput = document.getElementById('quantity');
      const quantity = parseInt(quantityInput?.value) || 1;
      
      try {
        // RÃ©cupÃ©rer les infos produit actuelles
        const response = await BrandiaAPI.Products.getByIdWithPromotion(productId);
        if (!response.success) throw new Error('Produit non trouvÃ©');
        
        const product = response.data?.product || response.data;
        
        // Ajouter au panier via API
        BrandiaAPI.Cart.add({
          id: product.id,
          product_id: product.id,
          name: product.name,
          price: parseFloat(product.final_price || product.price),
          base_price: parseFloat(product.base_price || product.price),
          has_promotion: product.has_promotion || false,
          promo_code: product.promo_code || null,
          main_image_url: product.main_image_url || product.image,
          stock: product.stock
        }, quantity);
        
        // Feedback visuel
        showToast('Produit ajoutÃ© au panier !', 'success');
        updateCartBadge();
        
      } catch (error) {
        console.error('[AddToCart] Error:', error);
        showToast('Erreur lors de l\'ajout au panier', 'error');
      }
    }

    function formatPrice(amount) {
      return new Intl.NumberFormat('fr-FR', {
        style: 'currency',
        currency: 'EUR'
      }).format(amount || 0);
    }

    function showError(message) {
      const container = document.getElementById('product-container');
      container.innerHTML = `
        <div class="col-span-full text-center py-20">
          <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-red-500/10 flex items-center justify-center">
            <i class="fas fa-exclamation-triangle text-3xl text-red-500"></i>
          </div>
          <h2 class="text-2xl font-bold text-white mb-2">Oups !</h2>
          <p class="text-slate-400 mb-6">${message}</p>
          <a href="catalogue.html" class="inline-flex items-center gap-2 text-pink-400 hover:text-pink-300 font-medium transition">
            <i class="fas fa-arrow-left"></i>
            Retour au catalogue
          </a>
        </div>
      `;
    }

    function showToast(message, type = 'success') {
      // Supprimer ancien toast
      const oldToast = document.querySelector('.toast');
      if (oldToast) oldToast.remove();
      
      // CrÃ©er le toast
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(toast);
      
      // Animer
      requestAnimationFrame(() => {
        toast.classList.add('show');
      });
      
      // Supprimer aprÃ¨s 3s
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // ==========================================
    // INITIALISATION PAYS
    // ==========================================
    function initCountries() {
      const selector = document.getElementById('countrySelector');
      if (!selector) return;
      
      const countries = {
        'AF': { name: 'Afghanistan', currency: 'AFN' },
      'AL': { name: 'Albanie', currency: 'ALL' },
      'DZ': { name: 'AlgÃ©rie', currency: 'DZD' },
      'AD': { name: 'Andorre', currency: 'EUR' },
      'AO': { name: 'Angola', currency: 'AOA' },
      'AG': { name: 'Antigua-et-Barbuda', currency: 'XCD' },
      'AR': { name: 'Argentine', currency: 'ARS' },
      'AM': { name: 'ArmÃ©nie', currency: 'AMD' },
      'AU': { name: 'Australie', currency: 'AUD' },
      'AT': { name: 'Autriche', currency: 'EUR' },
      'AZ': { name: 'AzerbaÃ¯djan', currency: 'AZN' },
      'BS': { name: 'Bahamas', currency: 'BSD' },
      'BH': { name: 'BahreÃ¯n', currency: 'BHD' },
      'BD': { name: 'Bangladesh', currency: 'BDT' },
      'BB': { name: 'Barbade', currency: 'BBD' },
      'BY': { name: 'BiÃ©lorussie', currency: 'BYN' },
      'BE': { name: 'Belgique', currency: 'EUR' },
      'BZ': { name: 'Belize', currency: 'BZD' },
      'BJ': { name: 'BÃ©nin', currency: 'XOF' },
      'BT': { name: 'Bhoutan', currency: 'BTN' },
      'BO': { name: 'Bolivie', currency: 'BOB' },
      'BA': { name: 'Bosnie-HerzÃ©govine', currency: 'BAM' },
      'BW': { name: 'Botswana', currency: 'BWP' },
      'BR': { name: 'BrÃ©sil', currency: 'BRL' },
      'BN': { name: 'Brunei', currency: 'BND' },
      'BG': { name: 'Bulgarie', currency: 'BGN' },
      'BF': { name: 'Burkina Faso', currency: 'XOF' },
      'BI': { name: 'Burundi', currency: 'BIF' },
      'CV': { name: 'Cap-Vert', currency: 'CVE' },
      'KH': { name: 'Cambodge', currency: 'KHR' },
      'CM': { name: 'Cameroun', currency: 'XAF' },
      'CA': { name: 'Canada', currency: 'CAD' },
      'CF': { name: 'Centrafrique', currency: 'XAF' },
      'TD': { name: 'Tchad', currency: 'XAF' },
      'CL': { name: 'Chili', currency: 'CLP' },
      'CN': { name: 'Chine', currency: 'CNY' },
      'CO': { name: 'Colombie', currency: 'COP' },
      'KM': { name: 'Comores', currency: 'KMF' },
      'CG': { name: 'Congo', currency: 'XAF' },
      'CD': { name: 'Congo (RDC)', currency: 'CDF' },
      'CR': { name: 'Costa Rica', currency: 'CRC' },
      'CI': { name: 'CÃ´te dâ€™Ivoire', currency: 'XOF' },
      'HR': { name: 'Croatie', currency: 'EUR' },
      'CU': { name: 'Cuba', currency: 'CUP' },
      'CY': { name: 'Chypre', currency: 'EUR' },
      'CZ': { name: 'RÃ©publique tchÃ¨que', currency: 'CZK' },
      'DK': { name: 'Danemark', currency: 'DKK' },
      'DJ': { name: 'Djibouti', currency: 'DJF' },
      'DM': { name: 'Dominique', currency: 'XCD' },
      'DO': { name: 'RÃ©publique dominicaine', currency: 'DOP' },
      'EC': { name: 'Ã‰quateur', currency: 'USD' },
      'EG': { name: 'Ã‰gypte', currency: 'EGP' },
      'SV': { name: 'Salvador', currency: 'USD' },
      'GQ': { name: 'GuinÃ©e Ã©quatoriale', currency: 'XAF' },
      'ER': { name: 'Ã‰rythrÃ©e', currency: 'ERN' },
      'EE': { name: 'Estonie', currency: 'EUR' },
      'ET': { name: 'Ã‰thiopie', currency: 'ETB' },
      'FJ': { name: 'Fidji', currency: 'FJD' },
      'FI': { name: 'Finlande', currency: 'EUR' },
      'FR': { name: 'France', currency: 'EUR' },
      'GA': { name: 'Gabon', currency: 'XAF' },
      'GM': { name: 'Gambie', currency: 'GMD' },
      'GE': { name: 'GÃ©orgie', currency: 'GEL' },
      'DE': { name: 'Allemagne', currency: 'EUR' },
      'GH': { name: 'Ghana', currency: 'GHS' },
      'GR': { name: 'GrÃ¨ce', currency: 'EUR' },
      'GD': { name: 'Grenade', currency: 'XCD' },
      'GT': { name: 'Guatemala', currency: 'GTQ' },
      'GN': { name: 'GuinÃ©e', currency: 'GNF' },
      'GW': { name: 'GuinÃ©e-Bissau', currency: 'XOF' },
      'GY': { name: 'Guyana', currency: 'GYD' },
      'HT': { name: 'HaÃ¯ti', currency: 'HTG' },
      'HN': { name: 'Honduras', currency: 'HNL' },
      'HU': { name: 'Hongrie', currency: 'HUF' },
      'IS': { name: 'Islande', currency: 'ISK' },
      'IN': { name: 'Inde', currency: 'INR' },
      'ID': { name: 'IndonÃ©sie', currency: 'IDR' },
      'IR': { name: 'Iran', currency: 'IRR' },
      'IQ': { name: 'Irak', currency: 'IQD' },
      'IE': { name: 'Irlande', currency: 'EUR' },
      'IL': { name: 'IsraÃ«l', currency: 'ILS' },
      'IT': { name: 'Italie', currency: 'EUR' },
      'JM': { name: 'JamaÃ¯que', currency: 'JMD' },
      'JP': { name: 'Japon', currency: 'JPY' },
      'JO': { name: 'Jordanie', currency: 'JOD' },
      'KZ': { name: 'Kazakhstan', currency: 'KZT' },
      'KE': { name: 'Kenya', currency: 'KES' },
      'KI': { name: 'Kiribati', currency: 'AUD' },
      'KP': { name: 'CorÃ©e du Nord', currency: 'KPW' },
      'KR': { name: 'CorÃ©e du Sud', currency: 'KRW' },
      'KW': { name: 'KoweÃ¯t', currency: 'KWD' },
      'KG': { name: 'Kirghizistan', currency: 'KGS' },
      'LA': { name: 'Laos', currency: 'LAK' },
      'LV': { name: 'Lettonie', currency: 'EUR' },
      'LB': { name: 'Liban', currency: 'LBP' },
      'LS': { name: 'Lesotho', currency: 'LSL' },
      'LR': { name: 'LibÃ©ria', currency: 'LRD' },
      'LY': { name: 'Libye', currency: 'LYD' },
      'LI': { name: 'Liechtenstein', currency: 'CHF' },
      'LT': { name: 'Lituanie', currency: 'EUR' },
      'LU': { name: 'Luxembourg', currency: 'EUR' },
      'MG': { name: 'Madagascar', currency: 'MGA' },
      'MW': { name: 'Malawi', currency: 'MWK' },
      'MY': { name: 'Malaisie', currency: 'MYR' },
      'MV': { name: 'Maldives', currency: 'MVR' },
      'ML': { name: 'Mali', currency: 'XOF' },
      'MT': { name: 'Malte', currency: 'EUR' },
      'MH': { name: 'ÃŽles Marshall', currency: 'USD' },
      'MR': { name: 'Mauritanie', currency: 'MRO' },
      'MU': { name: 'Maurice', currency: 'MUR' },
      'MX': { name: 'Mexique', currency: 'MXN' },
      'FM': { name: 'Ã‰tats fÃ©dÃ©rÃ©s de MicronÃ©sie', currency: 'USD' },
      'MD': { name: 'Moldavie', currency: 'MDL' },
      'MC': { name: 'Monaco', currency: 'EUR' },
      'MN': { name: 'Mongolie', currency: 'MNT' },
      'ME': { name: 'MontÃ©nÃ©gro', currency: 'EUR' },
      'MA': { name: 'Maroc', currency: 'MAD' },
      'MZ': { name: 'Mozambique', currency: 'MZN' },
      'MM': { name: 'Myanmar', currency: 'MMK' },
      'NA': { name: 'Namibie', currency: 'NAD' },
      'NR': { name: 'Nauru', currency: 'AUD' },
      'NP': { name: 'NÃ©pal', currency: 'NPR' },
      'NL': { name: 'Pays-Bas', currency: 'EUR' },
      'NZ': { name: 'Nouvelle-ZÃ©lande', currency: 'NZD' },
      'NI': { name: 'Nicaragua', currency: 'NIO' },
      'NE': { name: 'Niger', currency: 'XOF' },
      'NG': { name: 'NigÃ©ria', currency: 'NGN' },
      'NO': { name: 'NorvÃ¨ge', currency: 'NOK' },
      'OM': { name: 'Oman', currency: 'OMR' },
      'PK': { name: 'Pakistan', currency: 'PKR' },
      'PW': { name: 'Palaos', currency: 'USD' },
      'PA': { name: 'Panama', currency: 'PAB' },
      'PG': { name: 'Papouasie-Nouvelle-GuinÃ©e', currency: 'PGK' },
      'PY': { name: 'Paraguay', currency: 'PYG' },
      'PE': { name: 'PÃ©rou', currency: 'PEN' },
      'PH': { name: 'Philippines', currency: 'PHP' },
      'PL': { name: 'Pologne', currency: 'PLN' },
      'PT': { name: 'Portugal', currency: 'EUR' },
      'QA': { name: 'Qatar', currency: 'QAR' },
      'RO': { name: 'Roumanie', currency: 'RON' },
      'RU': { name: 'Russie', currency: 'RUB' },
      'RW': { name: 'Rwanda', currency: 'RWF' },
      'KN': { name: 'Saint-Kitts-et-Nevis', currency: 'XCD' },
      'LC': { name: 'Sainte-Lucie', currency: 'XCD' },
      'VC': { name: 'Saint-Vincent-et-les-Grenadines', currency: 'XCD' },
      'WS': { name: 'Samoa', currency: 'WST' },
      'SM': { name: 'Saint-Marin', currency: 'EUR' },
      'ST': { name: 'Sao TomÃ©-et-Principe', currency: 'STN' },
      'SA': { name: 'Arabie saoudite', currency: 'SAR' },
      'SN': { name: 'SÃ©nÃ©gal', currency: 'XOF' },
      'RS': { name: 'Serbie', currency: 'RSD' },
      'SC': { name: 'Seychelles', currency: 'SCR' },
      'SL': { name: 'Sierra Leone', currency: 'SLL' },
      'SG': { name: 'Singapour', currency: 'SGD' },
      'SK': { name: 'Slovaquie', currency: 'EUR' },
      'SI': { name: 'SlovÃ©nie', currency: 'EUR' },
      'SB': { name: 'ÃŽles Salomon', currency: 'SBD' },
      'SO': { name: 'Somalie', currency: 'SOS' },
      'ZA': { name: 'Afrique du Sud', currency: 'ZAR' },
      'ES': { name: 'Espagne', currency: 'EUR' },
      'LK': { name: 'Sri Lanka', currency: 'LKR' },
      'SD': { name: 'Soudan', currency: 'SDG' },
      'SR': { name: 'Suriname', currency: 'SRD' },
      'SE': { name: 'SuÃ¨de', currency: 'SEK' },
      'CH': { name: 'Suisse', currency: 'CHF' },
      'SY': { name: 'Syrie', currency: 'SYP' },
      'TW': { name: 'TaÃ¯wan', currency: 'TWD' },
      'TJ': { name: 'Tadjikistan', currency: 'TJS' },
      'TZ': { name: 'Tanzanie', currency: 'TZS' },
      'TH': { name: 'ThaÃ¯lande', currency: 'THB' },
      'TL': { name: 'Timor oriental', currency: 'USD' },
      'TG': { name: 'Togo', currency: 'XOF' },
      'TO': { name: 'Tonga', currency: 'TOP' },
      'TT': { name: 'TrinitÃ©-et-Tobago', currency: 'TTD' },
      'TN': { name: 'Tunisie', currency: 'TND' },
      'TR': { name: 'Turquie', currency: 'TRY' },
      'TM': { name: 'TurkmÃ©nistan', currency: 'TMT' },
      'UG': { name: 'Ouganda', currency: 'UGX' },
      'UA': { name: 'Ukraine', currency: 'UAH' },
      'AE': { name: 'Ã‰mirats arabes unis', currency: 'AED' },
      'GB': { name: 'Royaume-Uni', currency: 'GBP' },
      'US': { name: 'Ã‰tats-Unis', currency: 'USD' },
      'UY': { name: 'Uruguay', currency: 'UYU' },
      'UZ': { name: 'OuzbÃ©kistan', currency: 'UZS' },
      'VU': { name: 'Vanuatu', currency: 'VUV' },
      'VE': { name: 'Venezuela', currency: 'VES' },
      'VN': { name: 'ViÃªt Nam', currency: 'VND' },
      'YE': { name: 'YÃ©men', currency: 'YER' },
      'ZM': { name: 'Zambie', currency: 'ZMW' },
      'ZW': { name: 'Zimbabwe', currency: 'ZWL' }
      };

      const saved = localStorage.getItem('country') || 'FR';
      
      selector.innerHTML = Object.entries(countries)
        .map(([code, c]) => `<option value="${code}" ${code === saved ? 'selected' : ''}>${c.flag} ${c.name}</option>`)
        .join('');

      selector.addEventListener('change', (e) => {
        const code = e.target.value;
        localStorage.setItem('country', code);
        localStorage.setItem('currency', countries[code].currency);
      });
    }

    // ==========================================
    // AUTHENTIFICATION
    // ==========================================
    function initAuth() {
      const user = BrandiaAPI?.Auth?.getUser ? BrandiaAPI.Auth.getUser() : null;
      
      const authButtons = document.getElementById('auth-buttons');
      const userMenu = document.getElementById('user-menu');
      const userName = document.getElementById('user-name');
      
      if (user?.email) {
        if (authButtons) authButtons.classList.add('hidden');
        if (userMenu) {
          userMenu.classList.remove('hidden');
          userMenu.classList.add('flex');
        }
        if (userName) userName.textContent = user.first_name || user.email.split('@')[0];
      } else {
        if (authButtons) authButtons.classList.remove('hidden');
        if (userMenu) {
          userMenu.classList.add('hidden');
          userMenu.classList.remove('flex');
        }
      }
    }

    function logout() {
      if (BrandiaAPI?.Auth?.logout) {
        BrandiaAPI.Auth.logout();
      } else {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = 'index.html';
      }
    }

    function updateCartBadge() {
      if (BrandiaAPI?.Cart?.updateBadge) {
        BrandiaAPI.Cart.updateBadge();
      } else {
        const cart = JSON.parse(localStorage.getItem('brandia_cart') || '[]');
        const count = cart.reduce((sum, item) => sum + (parseInt(item.quantity) || 0), 0);
        const badge = document.getElementById('cart-count');
        if (badge) {
          badge.textContent = count > 99 ? '99+' : count;
          badge.classList.toggle('hidden', count === 0);
        }
      }
    }

    // ==========================================
    // DÃ‰MARRAGE
    // ==========================================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[Product] Page loaded, initializing...');
      
      initCountries();
      initAuth();
      updateCartBadge();
      
      // Charger le produit avec dÃ©lai pour s'assurer que l'API est prÃªte
      setTimeout(loadProduct, 100);
    });

    // Gestion touche Escape pour fermer la pub
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && window.brandiaAds) {
        window.brandiaAds.close();
      }
    });
  </script>

</body>
</html>