<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produit - Brandia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="assets/js/api.js"></script>
  <script src="assets/js/brandia-ads.js"></script>
  <style>
    body { background-color: #0b111e; color: #f3f4f6; font-family: system-ui, sans-serif; }
    .container { max-width: 1200px; margin: auto; padding: 0 1rem; }
    .gallery-thumb { cursor: pointer; opacity: 0.6; transition: all 0.2s; border: 2px solid transparent; }
    .gallery-thumb:hover, .gallery-thumb.active { opacity: 1; border-color: #6366f1; }
    .zoom-container { overflow: hidden; cursor: zoom-in; }
    .zoom-container img { transition: transform 0.3s ease; }
    .zoom-container:hover img { transform: scale(1.15); }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; border-radius: 8px; color: white; font-weight: 500; z-index: 1000; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: #10b981; }
    .toast.error { background: #ef4444; }
    .toast.warning { background: #f59e0b; }
    .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
  </style>
</head>
<body>

<header class="sticky top-0 z-40 bg-neutral-900/95 backdrop-blur border-b border-neutral-800">
  <nav class="container flex items-center justify-between px-4 py-3">
    <a href="index.html" class="flex items-center space-x-3">
      <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded flex items-center justify-center">
        <i class="fas fa-store text-white text-sm"></i>
      </div>
      <span class="font-bold text-lg text-neutral-100">Brandia</span>
    </a>
    
    <div class="hidden md:flex items-center space-x-6 text-sm text-neutral-300">
      <a href="catalogue.html" class="hover:text-white transition">Catalogue</a>
      <a href="index.html" class="hover:text-white transition">Accueil</a>
    </div>

    <div class="flex items-center space-x-3">
      <select id="countrySelector" class="px-2 py-1 bg-neutral-800 rounded text-xs text-neutral-300 border border-neutral-700 focus:border-indigo-500 outline-none min-w-[140px]">
        <option value="">Chargement...</option>
      </select>
      
      <div id="auth-buttons" class="flex items-center space-x-2">
        <a href="login.html" class="text-sm text-neutral-300 hover:text-white transition">Connexion</a>
      </div>
      
      <div id="user-menu" class="hidden items-center space-x-3">
        <span id="user-name" class="text-sm text-neutral-300"></span>
        <button onclick="logout()" class="text-sm text-red-400 hover:text-red-300 transition">Déconnexion</button>
      </div>

      <a href="panier.html" class="relative">
        <i class="fas fa-shopping-bag text-neutral-300"></i>
        <span id="cart-count" class="absolute -top-1 -right-1 bg-indigo-500 text-xs rounded-full w-4 h-4 flex items-center justify-center text-white hidden">0</span>
      </a>
    </div>
  </nav>
</header>

<section class="border-b border-neutral-800 bg-neutral-900/30">
  <div class="container px-4 py-3">
    <div class="flex items-center text-sm text-neutral-400">
      <a href="index.html" class="hover:text-white transition">Accueil</a>
      <i class="fas fa-chevron-right text-xs mx-2"></i>
      <a href="catalogue.html" class="hover:text-white transition">Catalogue</a>
      <i class="fas fa-chevron-right text-xs mx-2"></i>
      <span id="breadcrumb-product" class="text-neutral-500">Produit</span>
    </div>
  </div>
</section>

<div id="loading-state" class="container px-4 py-20 text-center">
  <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500 mb-4"></div>
  <p class="text-neutral-400">Chargement du produit...</p>
</div>

<div id="error-state" class="hidden container px-4 py-20 text-center fade-in">
  <div class="w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
    <i class="fas fa-exclamation-triangle text-red-400 text-3xl"></i>
  </div>
  <h2 class="text-2xl font-bold text-white mb-2">Produit non disponible</h2>
  <p class="text-neutral-400 mb-6">Ce produit n'existe pas ou est temporairement indisponible.</p>
  <a href="catalogue.html" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg transition font-medium">
    Voir le catalogue
  </a>
</div>

<div id="product-content" class="hidden container px-4 py-8 fade-in">
  <!-- Content produit identique à l’existant (gallery, détails, stock, supplier...) -->
  <div class="grid lg:grid-cols-2 gap-8">
    <!-- Images & gallery -->
    <div class="space-y-4">
      <div class="relative aspect-square bg-neutral-800 rounded-xl overflow-hidden zoom-container">
        <img id="main-image" src="" alt="" class="w-full h-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1602607688652-9f3a0c96c646?w=800'">
        <div id="stock-badge" class="absolute top-4 left-4 px-3 py-1 rounded-full text-xs font-bold bg-emerald-500/20 text-emerald-400 border border-emerald-500/30">En stock</div>
      </div>
      <div class="flex gap-3 overflow-x-auto pb-2" id="gallery-thumbs"></div>
    </div>

    <!-- Détails produit -->
    <div class="space-y-6">
      <div>
        <div class="flex items-center gap-3 mb-3">
          <span id="product-category" class="px-3 py-1 bg-indigo-500/20 text-indigo-400 text-xs font-bold uppercase tracking-wider rounded-full">Catégorie</span>
          <span id="product-brand" class="px-3 py-1 bg-slate-700 text-slate-300 text-xs font-bold rounded-full cursor-pointer hover:bg-slate-600 transition"></span>
        </div>
        <h1 id="product-name" class="text-3xl md:text-4xl font-bold text-white mb-3">Nom du produit</h1>
        <div class="flex items-center gap-4 mb-4 flex-wrap">
          <div class="flex items-center gap-1 text-yellow-400" id="product-rating"></div>
          <span id="review-count" class="text-sm text-neutral-400">0 avis</span>
          <span class="text-neutral-600">|</span>
          <span id="product-sku" class="text-sm text-neutral-500 font-mono">REF: ---</span>
        </div>
      </div>

      <div class="flex items-baseline gap-4 flex-wrap">
        <span id="product-price" class="text-4xl font-bold text-white">-- €</span>
        <span id="product-old-price" class="hidden text-2xl text-neutral-500 line-through">-- €</span>
        <span id="product-discount" class="hidden px-3 py-1 bg-red-500/20 text-red-400 text-sm font-bold rounded-full border border-red-500/30">-0%</span>
      </div>

      <p id="product-description" class="text-neutral-300 leading-relaxed text-lg">Description...</p>

      <div class="flex items-center gap-4 pt-4">
        <div class="flex items-center border border-neutral-700 rounded-lg bg-neutral-900">
          <button onclick="updateQty(-1)" class="px-4 py-3 text-neutral-400 hover:text-white transition w-12">
            <i class="fas fa-minus"></i>
          </button>
          <span id="quantity" class="px-4 py-2 font-bold text-lg min-w-[3rem] text-center">1</span>
          <button onclick="updateQty(1)" class="px-4 py-3 text-neutral-400 hover:text-white transition w-12">
            <i class="fas fa-plus"></i>
          </button>
        </div>
        <button onclick="addToCart()" id="btn-add-cart" class="flex-1 btn-primary px-8 py-3 text-white font-bold rounded-lg transition flex items-center justify-center gap-2 hover:shadow-lg hover:shadow-indigo-500/25">
          <i class="fas fa-shopping-cart"></i>
          <span>Ajouter au panier</span>
        </button>
      </div>

      <div id="stock-info" class="flex items-center gap-2 text-sm text-emerald-400">
        <i class="fas fa-check-circle"></i>
        <span>En stock - Livraison 2-4 jours</span>
      </div>
    </div>
  </div>
</div>

<footer class="border-t border-neutral-800 py-10 bg-neutral-900 mt-12 text-center text-neutral-500 text-sm">
  <div class="container">
    <p>© 2026 Brandia – Marketplace officielle des marques</p>
  </div>
</footer>

<div id="toast" class="toast"></div>

<script>
// -----------------------------
// Variables globales
// -----------------------------
const COUNTRIES = {
  'DZ': { name: 'Algérie', currency: 'DZD' },
  'DE': { name: 'Allemagne', currency: 'EUR' },
  'FR': { name: 'France', currency: 'EUR' },
  'US': { name: 'États-Unis', currency: 'USD' },
  'GB': { name: 'Royaume-Uni', currency: 'GBP' },
  'IT': { name: 'Italie', currency: 'EUR' },
  'ES': { name: 'Espagne', currency: 'EUR' },
  'AU': { name: 'Australie', currency: 'AUD' },
  'BR': { name: 'Brésil', currency: 'BRL' },
  'CA': { name: 'Canada', currency: 'CAD' },
  'JP': { name: 'Japon', currency: 'JPY' },
  'KR': { name: 'Corée du Sud', currency: 'KRW' },
  'CN': { name: 'Chine', currency: 'CNY' },
  'CH': { name: 'Suisse', currency: 'CHF' },
  'SG': { name: 'Singapour', currency: 'SGD' },
  'TN': { name: 'Tunisie', currency: 'TND' }
};

let currentProduct = null;
let currentQty = 1;
let currentSupplierId = null;

// -----------------------------
// Toast
// -----------------------------
function showToast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 3000);
}

// -----------------------------
// Quantity update
// -----------------------------
function updateQty(delta) {
  const newQty = currentQty + delta;
  if (newQty < 1) return;
  if (currentProduct && newQty > currentProduct.stock_quantity) {
    showToast('Stock maximum atteint', 'warning');
    return;
  }
  currentQty = newQty;
  document.getElementById('quantity').textContent = currentQty;
}

// -----------------------------
// Load product (corrigé)
// -----------------------------
async function loadProduct() {
  const urlParams = new URLSearchParams(window.location.search);
  const productId = urlParams.get('id');
  
  if (!productId) {
    showError();
    return;
  }

  try {
    if (typeof BrandiaAPI === 'undefined') {
      throw new Error('API non chargée - vérifiez que api.js est bien inclus');
    }
    
    console.log('[Product] Loading product ID:', productId);
    
    const response = await BrandiaAPI.Products.getByIdWithPromotion(productId);
    console.log('[Product] API Response:', response);
    
    let product = null;
    
    if (response && response.success && response.data) {
      if (response.data.product) {
        product = response.data.product;
      } else if (response.data.id || response.data.name) {
        product = response.data;
      }
    } else if (response && (response.id || response.name)) {
      product = response;
    }
    
    if (!product || !product.id) {
      console.error('[Product] Product data invalid:', product);
      throw new Error('Données produit invalides');
    }
    
    console.log('[Product] Parsed product:', product);
    
    currentProduct = product;
    currentSupplierId = product.supplier_id || product.supplier?.id || product.user_id;
    
    window.currentProduct = {
      id: product.id,
      supplier_id: currentSupplierId
    };
    
    renderProduct(product);
    
    setTimeout(() => {
      if (window.brandiaAds && currentSupplierId) {
        console.log('[Ads] Triggering for supplier:', currentSupplierId);
        window.brandiaAds.checkAndShow(product.id, currentSupplierId);
      }
    }, 3000);
    
  } catch (err) {
    console.error('[Product] Error loading product:', err);
    showError();
  }
}

// -----------------------------
// Affichage produit (identique)
// -----------------------------
function renderProduct(p) {
  /* ... la fonction renderProduct complète que tu avais ... */
}

// -----------------------------
// Reste des fonctions (cart, gallery, auth, countries)
// -----------------------------
function addToCart() { /* ... */ }
function updateCartBadge() { /* ... */ }
function initCountries() { /* ... */ }
function getFlagEmoji(code) { /* ... */ }
function initAuth() { /* ... */ }
function logout() { localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.reload(); }

// -----------------------------
// Init
// -----------------------------
document.addEventListener('DOMContentLoaded', () => {
  initCountries();
  initAuth();
  updateCartBadge();
  loadProduct();
});
</script>

</body>
</html>
