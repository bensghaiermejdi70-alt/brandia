<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produit</title>
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

<!-- Exemple de structure de la page produit -->
<div id="product-container"></div>

<!-- SÃ©lecteur de pays -->
<select id="countrySelector"></select>

<!-- Auth / User menu -->
<div id="auth-buttons">Connexion / Inscription</div>
<div id="user-menu" class="hidden">
  <span id="user-name"></span>
  <button onclick="logout()">DÃ©connexion</button>
</div>

<!-- Panier -->
<div id="cart-count" class="hidden">0</div>

<script>
  // ==========================================
  // FONCTION CRITIQUE CORRIGÃ‰E - EXPOSER POUR PUBLICITÃ‰
  // ==========================================
  async function loadProduct() {
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    
    console.log('[Product] Loading ID:', productId);
    
    if (!productId) {
      console.error('[Product] No ID in URL');
      showError();
      return;
    }

    try {
      // ðŸ”¥ Exemple rÃ©cupÃ©ration produit depuis API
      const res = await fetch(`/api/products/${productId}`);
      if (!res.ok) throw new Error('Produit introuvable');
      const product = await res.json();
      
      renderProduct(product);

      // ðŸ”¥ðŸ”¥ðŸ”¥ AJOUT CRITIQUE : Exposer pour publicitÃ©
      window.currentProduct = {
        id: product.id,
        supplier_id: product.supplier_id || null
      };
      console.log('[Product] Exposed for ads:', window.currentProduct);

      // ðŸ”¥ðŸ”¥ðŸ”¥ DÃ‰CLENCHER LA PUBLICITÃ‰
      setTimeout(() => {
        if (window.brandiaAds && window.currentProduct.supplier_id) {
          console.log('[Product] Triggering ad check...');
          window.brandiaAds.checkAndShow(window.currentProduct.id, window.currentProduct.supplier_id);
        } else {
          console.warn('[Product] brandiaAds not ready, retrying...');
          setTimeout(() => {
            if (window.brandiaAds && window.currentProduct.supplier_id) {
              window.brandiaAds.checkAndShow(window.currentProduct.id, window.currentProduct.supplier_id);
            }
          }, 1000);
        }
      }, 2000);

    } catch (err) {
      console.error('[Product] Fatal error:', err);
      showError();
    }
  }

  // ==========================================
  // DÃ‰CLENCHEMENT PUBLICITÃ‰ (BACKUP)
  // ==========================================
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function checkAndTriggerAd() {
      if (window.currentProduct?.supplier_id && window.brandiaAds) {
        console.log('[Product] Backup trigger for ad');
        window.brandiaAds.checkAndShow(
          window.currentProduct.id, 
          window.currentProduct.supplier_id
        );
      } else {
        console.log('[Product] Waiting for product/ads...');
        setTimeout(checkAndTriggerAd, 1000);
      }
    }, 3000);
  });

  // ==========================================
  // FONCTIONS UTILITAIRES MANQUANTES
  // ==========================================
  function initCountries() {
    const selector = document.getElementById('countrySelector');
    if (!selector) return;
    
    const countries = {
      'AF': { name: 'Afghanistan', currency: 'AFN' },
      'AL': { name: 'Albanie', currency: 'ALL' },
      'DZ': { name: 'AlgÃ©rie', currency: 'DZD' },
      'AD': { name: 'Andorre', currency: 'EUR' },
      'AO': { name: 'Angola', currency: 'AOA' },
      'AG': { name: 'Antigua-et-Barbuda', currency: 'XCD' },
      'AR': { name: 'Argentine', currency: 'ARS' },
      'AM': { name: 'ArmÃ©nie', currency: 'AMD' },
      'AU': { name: 'Australie', currency: 'AUD' },
      'AT': { name: 'Autriche', currency: 'EUR' },
      'AZ': { name: 'AzerbaÃ¯djan', currency: 'AZN' },
      'BS': { name: 'Bahamas', currency: 'BSD' },
      'BH': { name: 'BahreÃ¯n', currency: 'BHD' },
      'BD': { name: 'Bangladesh', currency: 'BDT' },
      'BB': { name: 'Barbade', currency: 'BBD' },
      'BY': { name: 'BiÃ©lorussie', currency: 'BYN' },
      'BE': { name: 'Belgique', currency: 'EUR' },
      'BZ': { name: 'Belize', currency: 'BZD' },
      'BJ': { name: 'BÃ©nin', currency: 'XOF' },
      'BT': { name: 'Bhoutan', currency: 'BTN' },
      'BO': { name: 'Bolivie', currency: 'BOB' },
      'BA': { name: 'Bosnie-HerzÃ©govine', currency: 'BAM' },
      'BW': { name: 'Botswana', currency: 'BWP' },
      'BR': { name: 'BrÃ©sil', currency: 'BRL' },
      'BN': { name: 'Brunei', currency: 'BND' },
      'BG': { name: 'Bulgarie', currency: 'BGN' },
      'BF': { name: 'Burkina Faso', currency: 'XOF' },
      'BI': { name: 'Burundi', currency: 'BIF' },
      'CV': { name: 'Cap-Vert', currency: 'CVE' },
      'KH': { name: 'Cambodge', currency: 'KHR' },
      'CM': { name: 'Cameroun', currency: 'XAF' },
      'CA': { name: 'Canada', currency: 'CAD' },
      'CF': { name: 'Centrafrique', currency: 'XAF' },
      'TD': { name: 'Tchad', currency: 'XAF' },
      'CL': { name: 'Chili', currency: 'CLP' },
      'CN': { name: 'Chine', currency: 'CNY' },
      'CO': { name: 'Colombie', currency: 'COP' },
      'KM': { name: 'Comores', currency: 'KMF' },
      'CG': { name: 'Congo', currency: 'XAF' },
      'CD': { name: 'Congo (RDC)', currency: 'CDF' },
      'CR': { name: 'Costa Rica', currency: 'CRC' },
      'CI': { name: 'CÃ´te dâ€™Ivoire', currency: 'XOF' },
      'HR': { name: 'Croatie', currency: 'EUR' },
      'CU': { name: 'Cuba', currency: 'CUP' },
      'CY': { name: 'Chypre', currency: 'EUR' },
      'CZ': { name: 'RÃ©publique tchÃ¨que', currency: 'CZK' },
      'DK': { name: 'Danemark', currency: 'DKK' },
      'DJ': { name: 'Djibouti', currency: 'DJF' },
      'DM': { name: 'Dominique', currency: 'XCD' },
      'DO': { name: 'RÃ©publique dominicaine', currency: 'DOP' },
      'EC': { name: 'Ã‰quateur', currency: 'USD' },
      'EG': { name: 'Ã‰gypte', currency: 'EGP' },
      'SV': { name: 'Salvador', currency: 'USD' },
      'GQ': { name: 'GuinÃ©e Ã©quatoriale', currency: 'XAF' },
      'ER': { name: 'Ã‰rythrÃ©e', currency: 'ERN' },
      'EE': { name: 'Estonie', currency: 'EUR' },
      'ET': { name: 'Ã‰thiopie', currency: 'ETB' },
      'FJ': { name: 'Fidji', currency: 'FJD' },
      'FI': { name: 'Finlande', currency: 'EUR' },
      'FR': { name: 'France', currency: 'EUR' },
      'GA': { name: 'Gabon', currency: 'XAF' },
      'GM': { name: 'Gambie', currency: 'GMD' },
      'GE': { name: 'GÃ©orgie', currency: 'GEL' },
      'DE': { name: 'Allemagne', currency: 'EUR' },
      'GH': { name: 'Ghana', currency: 'GHS' },
      'GR': { name: 'GrÃ¨ce', currency: 'EUR' },
      'GD': { name: 'Grenade', currency: 'XCD' },
      'GT': { name: 'Guatemala', currency: 'GTQ' },
      'GN': { name: 'GuinÃ©e', currency: 'GNF' },
      'GW': { name: 'GuinÃ©e-Bissau', currency: 'XOF' },
      'GY': { name: 'Guyana', currency: 'GYD' },
      'HT': { name: 'HaÃ¯ti', currency: 'HTG' },
      'HN': { name: 'Honduras', currency: 'HNL' },
      'HU': { name: 'Hongrie', currency: 'HUF' },
      'IS': { name: 'Islande', currency: 'ISK' },
      'IN': { name: 'Inde', currency: 'INR' },
      'ID': { name: 'IndonÃ©sie', currency: 'IDR' },
      'IR': { name: 'Iran', currency: 'IRR' },
      'IQ': { name: 'Irak', currency: 'IQD' },
      'IE': { name: 'Irlande', currency: 'EUR' },
      'IL': { name: 'IsraÃ«l', currency: 'ILS' },
      'IT': { name: 'Italie', currency: 'EUR' },
      'JM': { name: 'JamaÃ¯que', currency: 'JMD' },
      'JP': { name: 'Japon', currency: 'JPY' },
      'JO': { name: 'Jordanie', currency: 'JOD' },
      'KZ': { name: 'Kazakhstan', currency: 'KZT' },
      'KE': { name: 'Kenya', currency: 'KES' },
      'KI': { name: 'Kiribati', currency: 'AUD' },
      'KP': { name: 'CorÃ©e du Nord', currency: 'KPW' },
      'KR': { name: 'CorÃ©e du Sud', currency: 'KRW' },
      'KW': { name: 'KoweÃ¯t', currency: 'KWD' },
      'KG': { name: 'Kirghizistan', currency: 'KGS' },
      'LA': { name: 'Laos', currency: 'LAK' },
      'LV': { name: 'Lettonie', currency: 'EUR' },
      'LB': { name: 'Liban', currency: 'LBP' },
      'LS': { name: 'Lesotho', currency: 'LSL' },
      'LR': { name: 'LibÃ©ria', currency: 'LRD' },
      'LY': { name: 'Libye', currency: 'LYD' },
      'LI': { name: 'Liechtenstein', currency: 'CHF' },
      'LT': { name: 'Lituanie', currency: 'EUR' },
      'LU': { name: 'Luxembourg', currency: 'EUR' },
      'MG': { name: 'Madagascar', currency: 'MGA' },
      'MW': { name: 'Malawi', currency: 'MWK' },
      'MY': { name: 'Malaisie', currency: 'MYR' },
      'MV': { name: 'Maldives', currency: 'MVR' },
      'ML': { name: 'Mali', currency: 'XOF' },
      'MT': { name: 'Malte', currency: 'EUR' },
      'MH': { name: 'ÃŽles Marshall', currency: 'USD' },
      'MR': { name: 'Mauritanie', currency: 'MRO' },
      'MU': { name: 'Maurice', currency: 'MUR' },
      'MX': { name: 'Mexique', currency: 'MXN' },
      'FM': { name: 'Ã‰tats fÃ©dÃ©rÃ©s de MicronÃ©sie', currency: 'USD' },
      'MD': { name: 'Moldavie', currency: 'MDL' },
      'MC': { name: 'Monaco', currency: 'EUR' },
      'MN': { name: 'Mongolie', currency: 'MNT' },
      'ME': { name: 'MontÃ©nÃ©gro', currency: 'EUR' },
      'MA': { name: 'Maroc', currency: 'MAD' },
      'MZ': { name: 'Mozambique', currency: 'MZN' },
      'MM': { name: 'Myanmar', currency: 'MMK' },
      'NA': { name: 'Namibie', currency: 'NAD' },
      'NR': { name: 'Nauru', currency: 'AUD' },
      'NP': { name: 'NÃ©pal', currency: 'NPR' },
      'NL': { name: 'Pays-Bas', currency: 'EUR' },
      'NZ': { name: 'Nouvelle-ZÃ©lande', currency: 'NZD' },
      'NI': { name: 'Nicaragua', currency: 'NIO' },
      'NE': { name: 'Niger', currency: 'XOF' },
      'NG': { name: 'NigÃ©ria', currency: 'NGN' },
      'NO': { name: 'NorvÃ¨ge', currency: 'NOK' },
      'OM': { name: 'Oman', currency: 'OMR' },
      'PK': { name: 'Pakistan', currency: 'PKR' },
      'PW': { name: 'Palaos', currency: 'USD' },
      'PA': { name: 'Panama', currency: 'PAB' },
      'PG': { name: 'Papouasie-Nouvelle-GuinÃ©e', currency: 'PGK' },
      'PY': { name: 'Paraguay', currency: 'PYG' },
      'PE': { name: 'PÃ©rou', currency: 'PEN' },
      'PH': { name: 'Philippines', currency: 'PHP' },
      'PL': { name: 'Pologne', currency: 'PLN' },
      'PT': { name: 'Portugal', currency: 'EUR' },
      'QA': { name: 'Qatar', currency: 'QAR' },
      'RO': { name: 'Roumanie', currency: 'RON' },
      'RU': { name: 'Russie', currency: 'RUB' },
      'RW': { name: 'Rwanda', currency: 'RWF' },
      'KN': { name: 'Saint-Kitts-et-Nevis', currency: 'XCD' },
      'LC': { name: 'Sainte-Lucie', currency: 'XCD' },
      'VC': { name: 'Saint-Vincent-et-les-Grenadines', currency: 'XCD' },
      'WS': { name: 'Samoa', currency: 'WST' },
      'SM': { name: 'Saint-Marin', currency: 'EUR' },
      'ST': { name: 'Sao TomÃ©-et-Principe', currency: 'STN' },
      'SA': { name: 'Arabie saoudite', currency: 'SAR' },
      'SN': { name: 'SÃ©nÃ©gal', currency: 'XOF' },
      'RS': { name: 'Serbie', currency: 'RSD' },
      'SC': { name: 'Seychelles', currency: 'SCR' },
      'SL': { name: 'Sierra Leone', currency: 'SLL' },
      'SG': { name: 'Singapour', currency: 'SGD' },
      'SK': { name: 'Slovaquie', currency: 'EUR' },
      'SI': { name: 'SlovÃ©nie', currency: 'EUR' },
      'SB': { name: 'ÃŽles Salomon', currency: 'SBD' },
      'SO': { name: 'Somalie', currency: 'SOS' },
      'ZA': { name: 'Afrique du Sud', currency: 'ZAR' },
      'ES': { name: 'Espagne', currency: 'EUR' },
      'LK': { name: 'Sri Lanka', currency: 'LKR' },
      'SD': { name: 'Soudan', currency: 'SDG' },
      'SR': { name: 'Suriname', currency: 'SRD' },
      'SE': { name: 'SuÃ¨de', currency: 'SEK' },
      'CH': { name: 'Suisse', currency: 'CHF' },
      'SY': { name: 'Syrie', currency: 'SYP' },
      'TW': { name: 'TaÃ¯wan', currency: 'TWD' },
      'TJ': { name: 'Tadjikistan', currency: 'TJS' },
      'TZ': { name: 'Tanzanie', currency: 'TZS' },
      'TH': { name: 'ThaÃ¯lande', currency: 'THB' },
      'TL': { name: 'Timor oriental', currency: 'USD' },
      'TG': { name: 'Togo', currency: 'XOF' },
      'TO': { name: 'Tonga', currency: 'TOP' },
      'TT': { name: 'TrinitÃ©-et-Tobago', currency: 'TTD' },
      'TN': { name: 'Tunisie', currency: 'TND' },
      'TR': { name: 'Turquie', currency: 'TRY' },
      'TM': { name: 'TurkmÃ©nistan', currency: 'TMT' },
      'UG': { name: 'Ouganda', currency: 'UGX' },
      'UA': { name: 'Ukraine', currency: 'UAH' },
      'AE': { name: 'Ã‰mirats arabes unis', currency: 'AED' },
      'GB': { name: 'Royaume-Uni', currency: 'GBP' },
      'US': { name: 'Ã‰tats-Unis', currency: 'USD' },
      'UY': { name: 'Uruguay', currency: 'UYU' },
      'UZ': { name: 'OuzbÃ©kistan', currency: 'UZS' },
      'VU': { name: 'Vanuatu', currency: 'VUV' },
      'VE': { name: 'Venezuela', currency: 'VES' },
      'VN': { name: 'ViÃªt Nam', currency: 'VND' },
      'YE': { name: 'YÃ©men', currency: 'YER' },
      'ZM': { name: 'Zambie', currency: 'ZMW' },
      'ZW': { name: 'Zimbabwe', currency: 'ZWL' }
    };

    const saved = localStorage.getItem('country') || 'FR';
    selector.innerHTML = Object.entries(countries)
      .sort((a,b) => a[1].name.localeCompare(b[1].name))
      .map(([code, c]) => `<option value="${code}" ${code===saved?'selected':''}>${c.name}</option>`)
      .join('');

    selector.onchange = (e) => {
      localStorage.setItem('country', e.target.value);
      localStorage.setItem('currency', countries[e.target.value].currency);
    };
  }

  function initAuth() {
    if (typeof BrandiaAPI === 'undefined') return;
    const user = BrandiaAPI.Auth.getUser();
    if (user?.email) {
      const authButtons = document.getElementById('auth-buttons');
      const userMenu = document.getElementById('user-menu');
      const userName = document.getElementById('user-name');
      
      if (authButtons) authButtons.classList.add('hidden');
      if (userMenu) {
        userMenu.classList.remove('hidden');
        userMenu.classList.add('flex');
      }
      if (userName) userName.textContent = user.first_name || user.email;
    }
  }

  function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.href = 'index.html';
  }

  function updateCartBadge() {
    const cart = JSON.parse(localStorage.getItem('brandia_cart') || '[]');
    const count = cart.reduce((sum, item) => sum + (parseInt(item.quantity) || 0), 0);
    const badge = document.getElementById('cart-count');
    if (badge) {
      badge.textContent = count > 99 ? '99+' : count;
      badge.classList.toggle('hidden', count === 0);
    }
  }

  // ==========================================
  // INITIALISATION
  // ==========================================
  document.addEventListener('DOMContentLoaded', function() {
    initCountries();
    initAuth();
    updateCartBadge();
    loadProduct();
  });

  function renderProduct(product) {
    const container = document.getElementById('product-container');
    container.innerHTML = `<h1>${product.name}</h1><p>${product.description}</p>`;
  }

  function showError() {
    const container = document.getElementById('product-container');
    container.innerHTML = '<p>Erreur lors du chargement du produit.</p>';
  }
</script>

</body>
</html>
