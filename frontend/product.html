<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produit - Brandia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="assets/js/api.js"></script>
  <style>
    body { background-color: #0b111e; color: #f3f4f6; font-family: system-ui, sans-serif; }
    .container { max-width: 1200px; margin: auto; padding: 0 1rem; }
    .gallery-thumb { cursor: pointer; opacity: 0.6; transition: all 0.2s; border: 2px solid transparent; }
    .gallery-thumb:hover, .gallery-thumb.active { opacity: 1; border-color: #6366f1; }
    .zoom-container { overflow: hidden; cursor: zoom-in; }
    .zoom-container img { transition: transform 0.3s ease; }
    .zoom-container:hover img { transform: scale(1.15); }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; border-radius: 8px; color: white; font-weight: 500; z-index: 1000; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: #10b981; }
    .toast.error { background: #ef4444; }
    .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
    
    /* Brand Ad Overlay Styles - Respecting the 40% rule */
    .brand-ad-overlay {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: flex-end; /* Align to bottom for 40% coverage */
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
    }
    
    .brand-ad-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .brand-ad-container {
      width: 100%;
      max-width: 600px;
      height: 40vh; /* Exactly 40% of viewport */
      max-height: 400px;
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
      border-radius: 24px 24px 0 0;
      position: relative;
      overflow: hidden;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: 0 -10px 40px -10px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-bottom: 0;
    }
    
    .brand-ad-overlay.active .brand-ad-container {
      transform: translateY(0);
    }
    
    .brand-ad-media {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.3;
    }
    
    .brand-ad-content {
      position: relative;
      z-index: 10;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 2rem;
      text-align: center;
    }
    
    .brand-ad-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 20;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .brand-ad-close:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }
    
    .brand-ad-badge {
      position: absolute;
      bottom: 0.5rem;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      color: rgba(255, 255, 255, 0.5);
      white-space: nowrap;
    }
    
    .brand-ad-timer {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: rgba(0, 0, 0, 0.5);
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 12px;
      color: white;
      font-variant-numeric: tabular-nums;
    }
    
    @media (max-width: 640px) {
      .brand-ad-container {
        height: 50vh; /* Slightly more on mobile for readability */
        max-width: 100%;
        border-radius: 20px 20px 0 0;
      }
    }
    
    /* Animation for CTA */
    @keyframes pulse-soft {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .brand-ad-cta {
      animation: pulse-soft 2s infinite;
    }
    
    .brand-ad-cta:hover {
      animation: none;
      transform: scale(1.05);
    }
  </style>
</head>
<body>

<header class="sticky top-0 z-40 bg-neutral-900/95 backdrop-blur border-b border-neutral-800">
  <nav class="container flex items-center justify-between px-4 py-3">
    <a href="index.html" class="flex items-center space-x-3">
      <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded flex items-center justify-center">
        <i class="fas fa-store text-white text-sm"></i>
      </div>
      <span class="font-bold text-lg text-neutral-100">Brandia</span>
    </a>
    
    <div class="hidden md:flex items-center space-x-6 text-sm text-neutral-300">
      <a href="catalogue.html" class="hover:text-white transition">Catalogue</a>
      <a href="index.html" class="hover:text-white transition">Accueil</a>
    </div>

    <div class="flex items-center space-x-3">
      <select id="countrySelector" class="px-2 py-1 bg-neutral-800 rounded text-xs text-neutral-300 border border-neutral-700 focus:border-indigo-500 outline-none min-w-[140px]">
        <option value="">Chargement...</option>
      </select>
      
      <div id="auth-buttons" class="flex items-center space-x-2">
        <a href="login.html" class="text-sm text-neutral-300 hover:text-white transition">Connexion</a>
      </div>
      
      <div id="user-menu" class="hidden items-center space-x-3">
        <span id="user-name" class="text-sm text-neutral-300"></span>
        <button onclick="logout()" class="text-sm text-red-400 hover:text-red-300 transition">D√©connexion</button>
      </div>

      <a href="panier.html" class="relative">
        <i class="fas fa-shopping-bag text-neutral-300"></i>
        <span id="cart-count" class="absolute -top-1 -right-1 bg-indigo-500 text-xs rounded-full w-4 h-4 flex items-center justify-center text-white hidden">0</span>
      </a>
    </div>
  </nav>
</header>

<section class="border-b border-neutral-800 bg-neutral-900/30">
  <div class="container px-4 py-3">
    <div class="flex items-center text-sm text-neutral-400">
      <a href="index.html" class="hover:text-white transition">Accueil</a>
      <i class="fas fa-chevron-right text-xs mx-2"></i>
      <a href="catalogue.html" class="hover:text-white transition">Catalogue</a>
      <i class="fas fa-chevron-right text-xs mx-2"></i>
      <span id="breadcrumb-product" class="text-neutral-500">Produit</span>
    </div>
  </div>
</section>

<div id="loading-state" class="container px-4 py-20 text-center">
  <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500 mb-4"></div>
  <p class="text-neutral-400">Chargement du produit...</p>
</div>

<div id="error-state" class="hidden container px-4 py-20 text-center fade-in">
  <div class="w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
    <i class="fas fa-exclamation-triangle text-red-400 text-3xl"></i>
  </div>
  <h2 class="text-2xl font-bold text-white mb-2">Produit non disponible</h2>
  <p class="text-neutral-400 mb-6">Ce produit n'existe pas ou est temporairement indisponible.</p>
  <a href="catalogue.html" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg transition font-medium">
    Voir le catalogue
  </a>
</div>

<div id="product-content" class="hidden container px-4 py-8 fade-in">
  <div class="grid lg:grid-cols-2 gap-8">
    
    <div class="space-y-4">
      <div class="relative aspect-square bg-neutral-800 rounded-xl overflow-hidden zoom-container">
        <img id="main-image" src="" alt="" class="w-full h-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1602607688652-9f3a0c96c646?w=800'">
        <div id="stock-badge" class="absolute top-4 left-4 px-3 py-1 rounded-full text-xs font-bold bg-emerald-500/20 text-emerald-400 border border-emerald-500/30">
          En stock
        </div>
      </div>
      <div class="flex gap-3 overflow-x-auto pb-2" id="gallery-thumbs"></div>
    </div>

    <div class="space-y-6">
      <div>
        <div class="flex items-center gap-3 mb-3">
          <span id="product-category" class="px-3 py-1 bg-indigo-500/20 text-indigo-400 text-xs font-bold uppercase tracking-wider rounded-full">Cat√©gorie</span>
          <span id="product-brand" class="px-3 py-1 bg-slate-700 text-slate-300 text-xs font-bold rounded-full cursor-pointer hover:bg-slate-600 transition"></span>
        </div>
        <h1 id="product-name" class="text-3xl md:text-4xl font-bold text-white mb-3">Nom du produit</h1>
        <div class="flex items-center gap-4 mb-4 flex-wrap">
          <div class="flex items-center gap-1 text-yellow-400" id="product-rating"></div>
          <span id="review-count" class="text-sm text-neutral-400">0 avis</span>
          <span class="text-neutral-600">|</span>
          <span id="product-sku" class="text-sm text-neutral-500 font-mono">REF: ---</span>
        </div>
      </div>

      <div class="flex items-baseline gap-4 flex-wrap">
        <span id="product-price" class="text-4xl font-bold text-white">-- ‚Ç¨</span>
        <span id="product-old-price" class="hidden        <span id="product-old-price" class="hidden text-2xl text-neutral-500 line-through">-- ‚Ç¨</span>
        <span id="product-discount" class="hidden px-3 py-1 bg-red-500/20 text-red-400 text-sm font-bold rounded-full border border-red-500/30">-0%</span>
      </div>

      <p id="product-description" class="text-neutral-300 leading-relaxed text-lg">Description...</p>

      <div class="flex items-center gap-4 pt-4">
        <div class="flex items-center border border-neutral-700 rounded-lg bg-neutral-900">
          <button onclick="updateQty(-1)" class="px-4 py-3 text-neutral-400 hover:text-white transition w-12">
            <i class="fas fa-minus"></i>
          </button>
          <span id="quantity" class="px-4 py-2 font-bold text-lg min-w-[3rem] text-center">1</span>
          <button onclick="updateQty(1)" class="px-4 py-3 text-neutral-400 hover:text-white transition w-12">
            <i class="fas fa-plus"></i>
          </button>
        </div>
        
        <button onclick="addToCart()" id="btn-add-cart" class="flex-1 btn-primary px-8 py-3 text-white font-bold rounded-lg transition flex items-center justify-center gap-2 hover:shadow-lg hover:shadow-indigo-500/25">
          <i class="fas fa-shopping-cart"></i>
          <span>Ajouter au panier</span>
        </button>
      </div>

      <div id="stock-info" class="flex items-center gap-2 text-sm text-emerald-400">
        <i class="fas fa-check-circle"></i>
        <span>En stock - Livraison 2-4 jours</span>
      </div>

      <!-- Trust Badges -->
      <div class="grid grid-cols-3 gap-4 pt-6 border-t border-neutral-800">
        <div class="text-center">
          <i class="fas fa-truck text-indigo-400 text-2xl mb-2"></i>
          <p class="text-xs text-neutral-400">Livraison gratuite d√®s 50‚Ç¨</p>
        </div>
        <div class="text-center">
          <i class="fas fa-shield-alt text-indigo-400 text-2xl mb-2"></i>
          <p class="text-xs text-neutral-400">Paiement s√©curis√©</p>
        </div>
        <div class="text-center">
          <i class="fas fa-undo text-indigo-400 text-2xl mb-2"></i>
          <p class="text-xs text-neutral-400">Retour sous 14 jours</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Supplier Info Section -->
  <div class="mt-12 pt-8 border-t border-neutral-800">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-bold text-white">Vendu par <span id="supplier-name">...</span></h3>
      <a href="#" id="supplier-link" class="text-indigo-400 hover:text-indigo-300 text-sm">Voir la boutique <i class="fas fa-arrow-right ml-1"></i></a>
    </div>
    <div class="bg-neutral-900 rounded-xl p-6 border border-neutral-800">
      <div class="flex items-start gap-4">
        <img id="supplier-logo" src="" class="w-16 h-16 rounded-lg object-cover bg-neutral-800 hidden" />
        <div id="supplier-initial" class="w-16 h-16 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-2xl font-bold text-white">
          B
        </div>
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-2">
            <h4 class="font-semibold text-lg" id="supplier-name-full">Brand Name</h4>
            <span class="px-2 py-0.5 bg-emerald-500/20 text-emerald-400 text-xs rounded-full">V√©rifi√©</span>
          </div>
          <p class="text-neutral-400 text-sm mb-3" id="supplier-description">Description du vendeur...</p>
          <div class="flex items-center gap-4 text-sm text-neutral-500">
            <span><i class="fas fa-star text-yellow-400 mr-1"></i> <span id="supplier-rating">4.8</span> (120 avis)</span>
            <span><i class="fas fa-box text-indigo-400 mr-1"></i> <span id="supplier-products">45</span> produits</span>
            <span><i class="fas fa-map-marker-alt text-red-400 mr-1"></i> <span id="supplier-location">France</span></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<footer class="border-t border-neutral-800 py-10 bg-neutral-900 mt-12 text-center text-neutral-500 text-sm">
  <div class="container">
    <p>¬© 2026 Brandia ‚Äì Marketplace officielle des marques</p>
  </div>
</footer>

<!-- Toast Notification -->
<div id="toast" class="toast"></div>

<!-- BRAND AD OVERLAY - Contextual Advertising -->
<!-- R√®gle d'or: 40% √©cran, 15s max, fermeture imm√©diate, son off, 1x/session -->
<div id="brand-ad-overlay" class="brand-ad-overlay">
  <div class="brand-ad-container" onclick="event.stopPropagation()">
    <!-- Timer for video (hidden for images) -->
    <div id="ad-timer" class="brand-ad-timer hidden">15</div>
    
    <!-- Close Button (always accessible) -->
    <button onclick="closeBrandAd()" class="brand-ad-close" aria-label="Fermer la publicit√©">
      <i class="fas fa-times text-white"></i>
    </button>
    
    <!-- Media Background -->
    <img id="ad-media-image" src="" alt="" class="brand-ad-media hidden" />
    <video id="ad-media-video" src="" class="brand-ad-media hidden" muted playsinline loop></video>
    
    <!-- Content Overlay -->
    <div class="brand-ad-content">
      <div class="max-w-xs">
        <h3 id="ad-headline" class="text-2xl md:text-3xl font-bold text-white mb-3 leading-tight drop-shadow-lg">
          Offre sp√©ciale de la marque
        </h3>
        <p id="ad-description" class="text-white/90 text-sm md:text-base mb-6 line-clamp-2 drop-shadow-md">
          D√©couvrez nos nouveaut√©s et profitez de promotions exclusives
        </p>
        <button id="ad-cta" onclick="handleAdClick()" class="brand-ad-cta px-8 py-3 bg-white text-indigo-900 rounded-full font-bold text-sm md:text-base shadow-2xl hover:bg-indigo-50 transition-all transform">
          Voir l'offre
        </button>
      </div>
    </div>
    
    <!-- Transparency Label -->
    <div class="brand-ad-badge">
      <i class="fas fa-info-circle mr-1"></i>
      Contenu propos√© par la marque que vous consultez
    </div>
    
    <!-- Progress Bar for Auto-close -->
    <div class="absolute bottom-0 left-0 right-0 h-1 bg-white/20">
      <div id="ad-progress" class="h-full bg-white/60 w-full origin-left transition-transform duration-[15000ms] ease-linear"></div>
    </div>
  </div>
</div>

<script>
const COUNTRIES = {
  'DZ': { name: 'Alg√©rie', currency: 'DZD' },
  'DE': { name: 'Allemagne', currency: 'EUR' },
  'SA': { name: 'Arabie Saoudite', currency: 'SAR' },
  'AU': { name: 'Australie', currency: 'AUD' },
  'AT': { name: 'Autriche', currency: 'EUR' },
  'BE': { name: 'Belgique', currency: 'EUR' },
  'BR': { name: 'Br√©sil', currency: 'BRL' },
  'CA': { name: 'Canada', currency: 'CAD' },
  'CN': { name: 'Chine', currency: 'CNY' },
  'KR': { name: 'Cor√©e du Sud', currency: 'KRW' },
  'EG': { name: '√âgypte', currency: 'EGP' },
  'AE': { name: '√âmirats Arabes Unis', currency: 'AED' },
  'ES': { name: 'Espagne', currency: 'EUR' },
  'US': { name: '√âtats-Unis', currency: 'USD' },
  'FI': { name: 'Finlande', currency: 'EUR' },
  'FR': { name: 'France', currency: 'EUR' },
  'IE': { name: 'Irlande', currency: 'EUR' },
  'IT': { name: 'Italie', currency: 'EUR' },
  'JP': { name: 'Japon', currency: 'JPY' },
  'KW': { name: 'Kowe√Øt', currency: 'KWD' },
  'MA': { name: 'Maroc', currency: 'MAD' },
  'NL': { name: 'Pays-Bas', currency: 'EUR' },
  'PT': { name: 'Portugal', currency: 'EUR' },
  'QA': { name: 'Qatar', currency: 'QAR' },
  'GB': { name: 'Royaume-Uni', currency: 'GBP' },
  'SG': { name: 'Singapour', currency: 'SGD' },
  'CH': { name: 'Suisse', currency: 'CHF' },
  'TN': { name: 'Tunisie', currency: 'TND' }
};

let currentProduct = null;
let currentQty = 1;
let currentSupplierId = null;
let adTimer = null;
let adShown = false;

function showToast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 3000);
}

function updateQty(delta) {
  const newQty = currentQty + delta;
  if (newQty < 1) return;
  if (currentProduct && newQty > currentProduct.stock_quantity) {
    showToast('Stock maximum atteint', 'warning');
    return;
  }
  currentQty = newQty;
  document.getElementById('quantity').textContent = currentQty;
}

async function loadProduct() {
  const urlParams = new URLSearchParams(window.location.search);
  const productId = urlParams.get('id');
  
  if (!productId) {
    showError();
    return;
  }

  try {
    if (typeof BrandiaAPI === 'undefined') {
      throw new Error('API non charg√©e');
    }
    
    const data = await BrandiaAPI.Products.getById(productId);
    let product = null;
    
    if (data && data.data && data.data.product) {
      product = data.data.product;
    } else if (data && data.data) {
      product = data.data;
    } else if (data && data.product) {
      product = data.product;
    } else if (data && data.id) {
      product = data;
    }
    
    if (!product) {
      throw new Error('Produit non trouv√©');
    }
    
    currentProduct = product;
    currentSupplierId = product.supplier_id || product.user_id;
    
    renderProduct(product);
    
    // Check for brand ad after product is loaded
    setTimeout(() => checkAndShowBrandAd(product), 2000); // Delay 2s for UX
    
  } catch (err) {
    console.error('[Product] Error:', err);
    showError();
  }
}

function showError() {
  document.getElementById('loading-state').classList.add('hidden');
  document.getElementById('error-state').classList.remove('hidden');
}

function renderProduct(p) {
  currentProduct = p;
  document.title = `${p.name} - Brandia`;
  
  // Basic Info
  document.getElementById('breadcrumb-product').textContent = p.name || 'Produit';
  document.getElementById('product-name').textContent = p.name || 'Sans nom';
  document.getElementById('product-category').textContent = p.category_name || p.category_slug || 'Cat√©gorie';
  document.getElementById('product-description').textContent = p.description || p.short_description || 'Aucune description';
  document.getElementById('product-sku').textContent = 'REF: ' + (p.sku || p.id);
  
  // Brand tag
  const brandEl = document.getElementById('product-brand');
  if (p.brand_name || p.supplier_name) {
    brandEl.textContent = p.brand_name || p.supplier_name;
    brandEl.classList.remove('hidden');
  } else {
    brandEl.classList.add('hidden');
  }
  
  // Pricing
  const price = parseFloat(p.price) || 0;
  document.getElementById('product-price').textContent = formatPrice(price);
  
  if (p.compare_price && parseFloat(p.compare_price) > price) {
    const oldPrice = parseFloat(p.compare_price);
    document.getElementById('product-old-price').textContent = formatPrice(oldPrice);
    document.getElementById('product-old-price').classList.remove('hidden');
    const pct = Math.round(((oldPrice - price) / oldPrice) * 100);
    const discountEl = document.getElementById('product-discount');
    discountEl.textContent = `-${pct}%`;
    discountEl.classList.remove('hidden');
  }
  
  // Images
  const imgUrl = (p.main_image_url || p.image_url || 'https://images.unsplash.com/photo-1555529669-e69e7aa0ba9a?w=600').trim();
  document.getElementById('main-image').src = imgUrl;
  document.getElementById('main-image').alt = p.name;
  
  // Gallery
  const thumbs = document.getElementById('gallery-thumbs');
  if (p.images && p.images.length > 1) {
    thumbs.innerHTML = p.images.map((img, idx) => 
      `<img src="${img.url || img}" class="gallery-thumb w-20 h-20 object-cover rounded-lg ${idx===0?'active':''}" onclick="changeImage(this)" data-url="${img.url || img}">`
    ).join('');
  } else {
    thumbs.innerHTML = `<img src="${imgUrl}" class="gallery-thumb w-20 h-20 object-cover rounded-lg active" onclick="changeImage(this)">`;
  }
  
  // Stock
  const stock = parseInt(p.stock_quantity) || 0;
  const badge = document.getElementById('stock-badge');
  const btn = document.getElementById('btn-add-cart');
  const info = document.getElementById('stock-info');
  
  if (stock > 0) {
    badge.textContent = stock > 10 ? 'En stock' : `Stock limit√© (${stock})`;
    badge.className = stock > 10 
      ? 'absolute top-4 left-4 px-3 py-1 rounded-full text-xs font-bold bg-emerald-500/20 text-emerald-400 border border-emerald-500/30'
      : 'absolute top-4 left-4 px-3 py-1 rounded-full text-xs font-bold bg-orange-500/20 text-orange-400 border border-orange-500/30';
    info.innerHTML = '<i class="fas fa-check-circle"></i><span>En stock - Livraison 2-4 jours</span>';
    info.className = 'flex items-center gap-2 text-sm text-emerald-400';
    btn.disabled = false;
  } else {
    badge.textContent = 'Rupture';
    badge.className = 'absolute top-4 left-4 px-3 py-1 rounded-full text-xs font-bold bg-red-500/20 text-red-400 border border-red-500/30';
    info.innerHTML = '<i class="fas fa-times-circle"></i><span>Produit en rupture de stock</span>';
    info.className = 'flex items-center gap-2 text-sm text-red-400';
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-times"></i><span>Indisponible</span>';
    btn.classList.add('opacity-50', 'cursor-not-allowed');
  }
  
  // Rating
  const rating = parseFloat(p.rating) || 0;
  const stars = Array(5).fill(0).map((_, i) => 
    `<i class="${i < Math.floor(rating) ? 'fas' : 'far'} fa-star text-yellow-400 text-sm"></i>`
  ).join('');
  document.getElementById('product-rating').innerHTML = stars;
  document.getElementById('review-count').textContent = `${p.reviews_count || 0} avis`;
  
  // Supplier Info
  if (p.supplier || p.brand) {
    const supplier = p.supplier || p.brand;
    document.getElementById('supplier-name').textContent = supplier.name || supplier.company_name || 'Marque';
    document.getElementById('supplier-name-full').textContent = supplier.name || supplier.company_name || 'Marque';
    document.getElementById('supplier-description').textContent = supplier.description || 'Vendeur professionnel sur Brandia';
    document.getElementById('supplier-rating').textContent = supplier.rating || '4.5';
    document.getElementById('supplier-products').textContent = supplier.products_count || '0';
    document.getElementById('supplier-location').textContent = supplier.country || 'France';
    
    if (supplier.logo_url) {
      document.getElementById('supplier-logo').src = supplier.logo_url;
      document.getElementById('supplier-logo').classList.remove('hidden');
      document.getElementById('supplier-initial').classList.add('hidden');
    } else {
      document.getElementById('supplier-initial').textContent = (supplier.name || supplier.company_name || 'B').charAt(0).toUpperCase();
    }
    
    document.getElementById('supplier-link').href = `brand.html?id=${supplier.id}`;
  }
  
  // Show content
  document.getElementById('loading-state').classList.add('hidden');
  document.getElementById('product-content').classList.remove('hidden');
}

function changeImage(thumb) {
  const url = thumb.dataset.url || thumb.src;
  document.getElementById('main-image').src = url;
  document.querySelectorAll('.gallery-thumb').forEach(t => t.classList.remove('active'));
  thumb.classList.add('active');
}

function addToCart() {
  if (!currentProduct || currentProduct.stock_quantity <= 0) return;
  
  // Add to cart logic
  const cart = JSON.parse(localStorage.getItem('brandia_cart') || '[]');
  const existing = cart.find(x => x.id === currentProduct.id);
  
  if (existing) {
    existing.quantity = (existing.quantity || 0) + currentQty;
  } else {
    cart.push({
      id: currentProduct.id,
      name: currentProduct.name,
      price: parseFloat(currentProduct.price),
      main_image_url: currentProduct.main_image_url,
      quantity: currentQty,
      supplier_id: currentSupplierId
    });
  }
  
  localStorage.setItem('brandia_cart', JSON.stringify(cart));
  showToast(`${currentQty} √ó ${currentProduct.name} ajout√©(s) au panier`);
  updateCartBadge();
  currentQty = 1;
  document.getElementById('quantity').textContent = '1';
}

function updateCartBadge() {
  const cart = JSON.parse(localStorage.getItem('brandia_cart') || '[]');
  const count = cart.reduce((a, b) => a + (b.quantity || 0), 0);
  const badge = document.getElementById('cart-count');
  if (count > 0) {
    badge.textContent = count > 99 ? '99+' : count;
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }
}

// ==========================================
// CONTEXTUAL ADVERTISING SYSTEM
// ==========================================

async function checkAndShowBrandAd(product) {
  // R√®gle 1: V√©rifier si d√©j√† vu dans cette session pour cette marque
  const sessionKey = `ad_seen_${product.supplier_id || product.user_id}`;
  if (sessionStorage.getItem(sessionKey)) {
    console.log('[BrandAd] Already seen for this supplier in this session');
    return;
  }
  
  // R√®gle 2: V√©rifier si l'utilisateur a ferm√© explicitement (respect)
  const closedKey = `ad_closed_${product.supplier_id}`;
  if (sessionStorage.getItem(closedKey)) {
    return;
  }
  
  try {
    // Fetch active campaign for this supplier
    const response = await fetch(`${BrandiaAPI.baseUrl}/supplier/campaigns/active?supplier_id=${product.supplier_id || product.user_id}&product_id=${product.id}`, {
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
    });
    
    if (!response.ok) throw new Error('No campaign');
    
    const data = await response.json();
    if (!data.success || !data.data) return;
    
    const campaign = data.data;
    
    // V√©rifier si produit est dans le ciblage
    if (campaign.target_products && 
        !campaign.target_products.includes(parseInt(product.id))) {
      return;
    }
    
    // Afficher la pub apr√®s d√©lai
    setTimeout(() => showBrandAd(campaign, sessionKey), 1000);
    
  } catch (e) {
    console.log('[BrandAd] No active campaign or error:', e);
  }
}

function showBrandAd(campaign, sessionKey) {
  if (adShown) return;
  adShown = true;
  
  const overlay = document.getElementById('brand-ad-overlay');
  const headline = document.getElementById('ad-headline');
  const desc = document.getElementById('ad-description');
  const cta = document.getElementById('ad-cta');
  const imgEl = document.getElementById('ad-media-image');
  const vidEl = document.getElementById('ad-media-video');
  const timerEl = document.getElementById('ad-timer');
  const progressEl = document.getElementById('ad-progress');
  
  // Set content
  headline.textContent = campaign.headline || 'Offre sp√©ciale';
  desc.textContent = campaign.description || '';
  cta.textContent = campaign.cta_text || 'Voir l\'offre';
  cta.dataset.link = campaign.cta_link || '#';
  cta.dataset.campaignId = campaign.id;
  
  // Media handling
  if (campaign.media_type === 'video' && campaign.media_url) {
    vidEl.src = campaign.media_url;
    vidEl.classList.remove('hidden');
    imgEl.classList.add('hidden');
    timerEl.classList.remove('hidden');
    
    // Play video muted (respect rule)
    vidEl.play().catch(e => console.log('Autoplay prevented:', e));
    
    // 15s countdown
    let timeLeft = 15;
    timerEl.textContent = timeLeft;
    
    const countdown = setInterval(() => {
      timeLeft--;
      timerEl.textContent = timeLeft;
      if (timeLeft <= 0) {
        clearInterval(countdown);
        closeBrandAd();
      }
    }, 1000);
    
    adTimer = countdown;
    
    // Auto-close video after 15s via CSS animation
    progressEl.style.transform = 'scaleX(0)';
    
  } else {
    // Image
    imgEl.src = campaign.media_url || campaign.image_url;
    imgEl.classList.remove('hidden');
    vidEl.classList.add('hidden');
    timerEl.classList.add('hidden');
    progressEl.style.transition = 'none';
    
    // Auto-close image after 8s (user can close earlier)
    setTimeout(() => closeBrandAd(), 8000);
  }
  
  // Mark as seen for this session
  sessionStorage.setItem(sessionKey, 'true');
  
  // Show overlay
  overlay.classList.add('active');
  document.body.style.overflow = 'hidden';
  
  // Track impression
  trackAdEvent(campaign.id, 'impression');
}

function closeBrandAd() {
  const overlay = document.getElementById('brand-ad-overlay');
  const vidEl = document.getElementById('ad-media-video');
  
  overlay.classList.remove('active');
  document.body.style.overflow = '';
  
  if (adTimer) {
    clearInterval(adTimer);
    adTimer = null;
  }
  
  vidEl.pause();
  vidEl.src = '';
  
  // Respect: mark as closed so it won't show again this session
  if (currentProduct) {
    sessionStorage.setItem(`ad_closed_${currentProduct.supplier_id}`, 'true');
  }
}

function handleAdClick() {
  const cta = document.getElementById('ad-cta');
  const link = cta.dataset.link;
  const campaignId = cta.dataset.campaignId;
  
  // Track click
  trackAdEvent(campaignId, 'click');
  
  // Navigate
  if (link && link !== '#') {
    if (link.startsWith('http')) {
      window.open(link, '_blank');
    } else {
      window.location.href = link;
    }
  }
  
  closeBrandAd();
}

async function trackAdEvent(campaignId, type) {
  try {
    await fetch(`${BrandiaAPI.baseUrl}/campaigns/${campaignId}/track`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify({ type, timestamp: new Date().toISOString() })
    });
  } catch (e) {
    console.error('Failed to track ad:', e);
  }
}

// Close on backdrop click (but not on container)
document.getElementById('brand-ad-overlay').addEventListener('click', function(e) {
  if (e.target === this) {
    closeBrandAd();
  }
});

// Close on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeBrandAd();
  }
});

// ==========================================
// UTILS
// ==========================================

function formatPrice(amount) {
  return new Intl.NumberFormat('fr-FR', {
    style: 'currency',
    currency: 'EUR'
  }).format(amount);
}

function initCountries() {
  const sel = document.getElementById('countrySelector');
  const saved = localStorage.getItem('country') || 'FR';
  
  sel.innerHTML = Object.entries(COUNTRIES)
    .sort((a, b) => a[1].name.localeCompare(b[1].name))
    .map(([code, c]) => `<option value="${code}" ${code===saved?'selected':''}>${getFlagEmoji(code)} ${c.name}</option>`)
    .join('');
  
  sel.onchange = (e) => {
    localStorage.setItem('country', e.target.value);
    localStorage.setItem('currency', COUNTRIES[e.target.value].currency);
  };
}

function getFlagEmoji(code) {
  const flags = {'FR':'üá´üá∑','DE':'üá©üá™','IT':'üáÆüáπ','ES':'üá™üá∏','NL':'üá≥üá±','BE':'üáßüá™','PT':'üáµüáπ','AT':'üá¶üáπ','IE':'üáÆüá™','FI':'üá´üáÆ','GB':'üá¨üáß','CH':'üá®üá≠','US':'üá∫üá∏','CA':'üá®üá¶','BR':'üáßüá∑','JP':'üáØüáµ','KR':'üá∞üá∑','CN':'üá®üá≥','SG':'üá∏üá¨','AU':'üá¶üá∫','TN':'üáπüá≥','DZ':'üá©üáø','MA':'üá≤üá¶','EG':'üá™üá¨','AE':'üá¶üá™','SA':'üá∏üá¶','QA':'üá∂üá¶','KW':'üá∞üáº'};
  return flags[code] || 'üè≥Ô∏è';
}

function initAuth() {
  const user = (typeof BrandiaAPI !== 'undefined') ? BrandiaAPI.Auth.getUser() : null;
  if (user && user.email) {
    document.getElementById('auth-buttons').classList.add('hidden');
    document.getElementById('user-menu').classList.remove('hidden');
    document.getElementById('user-menu').classList.add('flex');
    document.getElementById('user-name').textContent = user.first_name || user.email;
  }
}

function logout() {
  localStorage.removeItem('token');
  localStorage.removeItem('user');
  window.location.reload();
}

// Init
document.addEventListener('DOMContentLoaded', () => {
  initCountries();
  initAuth();
  updateCartBadge();
  loadProduct();
});
</script>
</body>
</html>